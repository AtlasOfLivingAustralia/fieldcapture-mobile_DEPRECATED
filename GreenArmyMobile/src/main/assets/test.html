

<!DOCTYPE html>
<head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <style type="text/css">
        input[type=checkbox] {
            -webkit-transform: scale(1.5); margin:50px;
        }
    </style>
    
    <script src="fieldcapture/static/UGoJGyG3j2UCffTg3vnOdi0FsnS2OvrmrsZD6WxaXGy.js" type="text/javascript" ></script>
<link href="fieldcapture/static/090onaZX1M508oSWqGmMeETZ9NkUA9p4CCTW3MUpRPc.css" type="text/css" rel="stylesheet" media="screen, projection" />

<link href="fieldcapture/static/CidRUyEAqkZsnDRPRiaGZBy7vd4DOlnRqweu4CsVcIG.css" type="text/css" rel="stylesheet" media="screen" />
<link href="fieldcapture/static/tDKPE9VWZfBnSnxBkPC52ml2dXticvlQDl9aR8VpM2o.css" type="text/css" rel="stylesheet" media="screen, projection" />
<!--[if lt IE 7]><link href="fieldcapture/static/v1vjA9BeNpSU8cuoTuVhTEUm6boSzwYQcgfPKKMkqgv.css" type="text/css" rel="stylesheet" media="screen, projection" /><![endif]-->

<link href="fieldcapture/static/Eu8FNKwJJQI8mVJO3VIshatRN1bunflYHvvdqk06tbf.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="http://www.ala.org.au/wp-content/themes/ala2011/images/favicon.ico" rel="shortcut icon" />
<!--[if lt IE 9]><script src="fieldcapture/static/Yh1Txee3hFzExJ4P1str7tGV24zQMEYtxqtlYJ5ukR0.js" type="text/javascript" ></script><![endif]-->
<link href="fieldcapture/static/6tuLClj7N5eYCZpx7vLn8juIbQUXBkCnWRUJFY7UDCz.css" type="text/css" rel="stylesheet" media="screen,print" />
<link href="/fieldcapture/static/7ARiB2rJgSkfi68hxnSlcG9Ot0gQ863DYxkCmSHQweE.png" rel="shortcut icon" />
<link href="/fieldcapture/static/14SWTr4VqVh6tnlUlgBtue6IJZ7gwE1y42RT7ya5GGW.png" rel="shortcut icon" />

<link href="fieldcapture/static/KYGDEVRRaKjNbTXJkHmicmzo9vFrnnzCnGLcxKjR04f.css" type="text/css" rel="stylesheet" media="screen,print" />

<link href="fieldcapture/static/uUQBvO5ITMKwLfoRb2u62GbHXEzxtsbrSWq8MBAOrbX.css" type="text/css" rel="stylesheet" media="screen,print" />
<link href="fieldcapture/static/2OXdKoom668LE7PLl0qjJCaLG7Pu7Jv869tAsS4e1oT.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="fieldcapture/static/AcXIjLTuc87n8sfxBjJRQSoBIUwP9RnCyK8Sv82i7eV.css" type="text/css" rel="stylesheet" media="screen, projection" />
<script type="text/javascript">
    var fcConfig = {
        serverUrl: "http://devt.ala.org.au:8087/fieldcapture",
        activityUpdateUrl: "/fieldcapture/activity/ajaxUpdate",
        activityDeleteUrl: "/fieldcapture/activity/ajaxDelete",
        projectViewUrl: "/fieldcapture/project/index/",
        siteViewUrl: "/fieldcapture/site/index/",
        bieUrl: "http://bie.ala.org.au",
        speciesProfileUrl: "/fieldcapture/proxy/speciesProfile"
        },
        here = document.location.href;
    </script>
    

    <meta name="layout" content="mobile"/>

    <script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false&language=en"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jstimezonedetect/1.0.4/jstz.min.js"></script>
    
    

</head>

<body>

<div id="content" class="clearfix">
    
<div class="container-fluid validationEngineContainer" id="validation-container">
<div id="koActivityMainBlock">

    <div class="row-fluid">
        <div class="span9">
            <!-- Common activity fields -->

            <div class="row-fluid space-after">
                <div class="span6">
                    <label for="theme">Major theme</label>
                    <select id="theme" data-bind="value:mainTheme, options:transients.themes, optionsCaption:'Choose..'" class="input-xlarge">
                    </select>
                </div>
                <div class="span6">
                    <label class="for-readonly">Description</label>
                    <span class="readonly-text" data-bind="text:description"></span>
                </div>
            </div>

            <div class="row-fluid space-after">

                <div class="span6">
                    <label class="for-readonly inline">Activity progress</label>
                    <button type="button" class="btn btn-small"
                            data-bind="css: {'btn-warning':progress()=='planned','btn-success':progress()=='started','btn-info':progress()=='finished','btn-danger':progress()=='deferred','btn-inverse':progress()=='cancelled'}"
                            style="line-height:16px;cursor:default;color:white">
                        <span data-bind="text: progress"></span>
                    </button>
                </div>
            </div>

            <div class="row-fluid space-after">
                <div class="span6">
                    <label class="for-readonly inline">Planned start date</label>
                    <span class="readonly-text" data-bind="text:plannedStartDate.formattedDate"></span>
                </div>
                <div class="span6">
                    <label class="for-readonly inline">Planned end date</label>
                    <span class="readonly-text" data-bind="text:plannedEndDate.formattedDate"></span>
                </div>
            </div>

            <div class="row-fluid">
                <div class="span6 required">
                    <label for="startDate"><b>Actual start date</b>
                        <a href='#' class='helphover' data-original-title='Start date' data-placement='top' data-content='Date the activity was started.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a>
                    </label>


                    <div class="input-append">
                        <input data-bind='datepicker:startDate.date' name='startDate' id='startDate' type='text' size='16' class='input-xlarge' targetField='startDate.date' data-validation-engine='validate[required]' />
<span class='add-on open-datepicker'>
  <i class='icon-th'>&nbsp;</i>
</span>
                    </div>

                </div>
                <div class="span6 required">
                    <label for="endDate"><b>Actual end date</b>
                        <a href='#' class='helphover' data-original-title='End date' data-placement='top' data-content='Date the activity finished.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a>
                    </label>

                    <div class="input-append">
                        <input data-bind='datepicker:endDate.date' name='endDate' id='endDate' type='text' size='16' class='input-xlarge' targetField='endDate.date' data-validation-engine='validate[future[startDate]]' />
<span class='add-on open-datepicker'>
  <i class='icon-th'>&nbsp;</i>
</span>
                    </div>

                </div>
            </div>


        </div>
        
            <div class="span3">
                <div id="smallMap" style="width:100%"></div>
            </div>
        
    </div>

</div>

<!-- ko stopBinding: true -->

    
    
    <style type="text/css">
        table.planting td:nth-child(1) {width:30%;}
        table.planting td:nth-child(1) select {width:100%;}
        table.planting td:nth-child(2) {width:10%;text-align:center;}
        table.planting td:nth-child(2) select {width:100%;}
        table.planting td:nth-child(3) {width:10%;text-align:center;}
        table.planting td:nth-child(3) select {width:100%;}
        table.planting td:nth-child(4) {width:10%;}
        table.planting td:nth-child(4) select {width:100%;}
        table.planting td:nth-child(5) {width:10%;}
        table.planting td:nth-child(5) select {width:100%;}
        table.planting td:nth-child(6) {width:10%;}
        table.planting td:nth-child(6) select {width:100%;}
        table.planting td:nth-child(7) {width:10%;}
        table.planting td:nth-child(7) select {width:100%;}
        table.planting td:last-child {width:4%;text-align:center;}
        table.planting textarea {width:98%;}
    </style>
    <div class="output-block" id="koRevegetation_Details">
        <h3 data-bind="css:{modified:dirtyFlag.isDirty},attr:{title:'Has been modified'}">Revegetation Details<i class="icon-asterisk modified-icon" data-bind="visible:dirtyFlag.isDirty" title="Has been modified" style="display: none;"></i></h3>
        <!-- add the dynamic components -->
        <div class="row-fluid output-section">
            <table class="table table-bordered planting " >
                <thead><tr><th class="required">Species:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The species planted / sown. (start typing a  scientific or common name for a species)'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th class="required">No. Planted:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Number of plants planted'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th class="required">Seed Sown (Kg):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Weight of seed direct sown in kilograms'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th>Type of stock<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The type of plantstock used for plantings'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th>Structural Layer<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The structural layer of vegetation that planted plants will occupy when mature'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th>Stock Provenance<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The name of the locality from which the seedstock was collected'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th>Type of Guard<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Type of guard used to protect planted seedlings'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th></th>
                </tr></thead>
                <tbody data-bind="template:{name:'plantingviewTmpl', foreach: data.planting}"></tbody>
                <script id="plantingviewTmpl" type="text/html"><tr>
                    <td>
<span class="input-prepend input-append" data-bind="with:species">
    <span class="add-on" data-bind="visible:!transients.editing(), css:{'btn-success':name()}"><i class="icon-white" data-bind="css:{'icon-ok':listId()!='unmatched' && name(), 'icon-question-sign':listId()=='unmatched'}"></i></span><span class="add-on" data-bind="visible:transients.editing()"><img src="/fieldcapture/static/Xo2jbaJ5EFqa59u9g4c4ybpCpw3wFWKhQdzZwNmmktO.gif" alt="saving icon" /></span><input type="text" data-bind="value:transients.textFieldValue,event:{focusout:focusLost},autocomplete:{url:'/fieldcapture/search/species', render: renderItem, listId: list, result:speciesSelected, valueChangeCallback:textFieldChanged}"  data-validation-engine='validate[required]'/>
    <span class="add-on" data-bind="visible: !transients.editing() && name()">
        <a href="#" data-bind="popover: {title: name, content: transients.speciesInformation}"><i class="icon-info-sign"></i></a>
    </span>
</span>
</td>
                    <td><input class="input-mini" style="text-align:center" data-bind='value:numberPlanted' data-validation-engine='validate[required,custom[number],min[0]]' type='number' class='input-mini'/></td>
                    <td><input class="input-mini" style="text-align:center" data-bind='value:seedSownKg' data-validation-engine='validate[required,custom[number],min[0]]' type='number' class='input-mini'/></td>
                    <td><select data-bind='value:stockType,options:transients.stockTypeConstraints,optionsCaption:"Please select"'></select></td>
                    <td><select data-bind='value:structuralLayer,options:transients.structuralLayerConstraints,optionsCaption:"Please select"'></select></td>
                    <td><input  class="input-mini" data-bind='value:stockProvenance'  type='text' class='input-small'/></td>
                    <td><select data-bind='value:guardType,options:transients.guardTypeConstraints,optionsCaption:"Please select"'></select></td>
                    <td><i data-bind='click:$root.removeplantingRow' class='icon-remove'></i></td>
                </tr></script>
                <tfoot>
                <tr>
                    <td><span >Total Seedlings Planted:</span></td>
                    <td><span  class="value" data-bind='text:data.totalNumberPlanted'></span></td>
                    <td><span >Total Seed Sown (Kg):</span></td>
                    <td><span  class="value" data-bind='text:data.totalSeedSownKg'></span></td>
                    <td colspan='3'><span ></span></td>
                    <td></td>
                </tr>
                <tr><td colspan="8" style="text-align:left;">
                        <button type="button" class="btn btn-small" data-bind="click:addplantingRow">
                        <i class="icon-plus"></i> Add a row</button>
                        <button type="button" class="btn btn-small" data-bind="click:showplantingTableDataUpload"><i class="icon-upload"></i> Upload data for this table</button>


                    </td></tr>
<tr data-bind="visible:plantingTableDataUploadVisible"><td colspan="8">
                <div class="text-error text-left">
                    Note: Only valid exact scientific names will be matched and populated from the database (indicated by a green tick). Unmatched species will load, but will be indicated by a green <b>?</b>. Please check your uploaded data and correct as required.
                </div>
                <div class="text-left" style="margin:5px">
                    <a href="/fieldcapture/proxy/excelOutputTemplate?type=Revegetation Details&listName=planting" target="plantingTemplateDownload" class="btn">Step 1 - Download template (.xlsx)</a>
                </div>
                <div class="text-left" style="margin:5px;">
                    <input type="checkbox" data-bind="checked:appendTableRows" style="margin-right:5px">Append uploaded data to table (unticking this checkbox will result in all table rows being replaced)
                </div>

                <div class="btn fileinput-button" style="margin-left:5px">
                        <input id="plantingTableDataUpload" type="file" name="data" data-bind="fileUploadNoImage:plantingTableDataUploadOptions">
                        Step 2 - Upload populated template
                </div>

                    </td></tr> <script id="plantingtemplate-upload" type="text/x-tmpl">{% %}</script>
                       <script id="plantingtemplate-download" type="text/x-tmpl">{% %}</script>                </tfoot>
            </table>
        </div>
<div class="row-fluid space-after output-section" >
<div class="span6">
<div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Vegetation at time of planting:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='General description of the vegetative cover on the planting site at the time of planting'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><select class="span8" data-bind='value:data.vegDescriptionAtPlanting,options:transients.vegDescriptionAtPlantingConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel"><label>Revegetation method:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The method used for planting'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><select class="span8" data-bind='value:data.revegetationMethod,options:transients.revegetationMethodConstraints,optionsCaption:"Please select"'></select></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel"><label>Equipment used:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Simple description of the type of planting equipment used'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><textarea  class="span8" data-bind='value:data.equipmentUsed'></textarea></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel"><label>Adjacent landuse:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The predominant land use adjoining the planting site'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><select class="span8" data-bind='value:data.adjacentLanduse,options:transients.adjacentLanduseConstraints,optionsCaption:"Please select"'></select></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Landscape connectivity:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Estimate of the &apos;connectedness&apos; of the planting site with other native vegetation around it. Choose the most representative category.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><select class="span8" data-bind='value:data.connectivityIndex,options:transients.connectivityIndexConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span></div></div><div class="span6">
<div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Area of revegetation works (Ha):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The area in hectares of the revegetation works area'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.areaRevegHa' data-validation-engine='validate[required,custom[number],min[0]]' type='number' class='input-mini'/></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 checkbox-list-label  preLabel"><label>Environmental benefits / outcomes expected to be achieved from this planting:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Environmental benefits /outcomes expected to be achieved through implementing the activity.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span>
            <ul class="checkbox-list" data-bind="foreach: transients.environmentalBenefitsConstraints">
                <li>
                    <input type="checkbox" name="data.environmentalBenefits" data-bind="value:$data,checked:$root.data.environmentalBenefits" /><span data-bind="text:$data"></span>
                </li>
            </ul>
        </span></div></div></div>
<div class="row-fluid space-after output-section" >
<span class="span12">    <span  class="preLabel"><label>Comments / Notes:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Please enter any additional comments or notes about this planting activity'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><textarea  class="span12" data-bind='value:data.notes'></textarea></span></div>

        
    </div>

    
    
    <style type="text/css">
        table.stockingDetails td:nth-child(1) {width:50%;}
        table.stockingDetails td:nth-child(1) select {width:100%;}
        table.stockingDetails td:nth-child(2) {text-align:center;}
        table.stockingDetails td:last-child {width:4%;text-align:center;}
        table.stockingDetails textarea {width:98%;}
    </style>
    <div class="output-block" id="koStock_Management_Details">
        <h3 data-bind="css:{modified:dirtyFlag.isDirty},attr:{title:'Has been modified'}">Stock Management Details<i class="icon-asterisk modified-icon" data-bind="visible:dirtyFlag.isDirty" title="Has been modified" style="display: none;"></i></h3>
        <!-- add the dynamic components -->
        <div class="row-fluid space-after output-section" >
<div class="span6">
<div class="row-fluid"><span class="span12">    <span  class="span4 checkbox-list-label  preLabel required"><label>What land management issue(s) are you using stock grazing to manage?:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Purpose for which grazing is being used as a management tool'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span>
            <ul class="checkbox-list" data-bind="foreach: transients.stockManagementReasonConstraints">
                <li>
                    <input type="checkbox" name="data.stockManagementReason" data-bind="value:$data,checked:$root.data.stockManagementReason"  data-validation-engine='validate[minCheckbox[1]]'/><span data-bind="text:$data"></span>
                </li>
            </ul>
        </span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Area managed (Ha):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Area in hectares where grazing is used as a management tool under this activity'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.areaOfStockManagementHa' data-validation-engine='validate[required,custom[number],min[0]]' type='number' class='input-mini'/></span></div></div><div class="span6">
<div class="row-fluid"><span class="span12">    <span  class="span4 preLabel"><label>Stocking strategy:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Description of the grazing strategy/methodology being used to achieve the purpose'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><textarea  class="span8" data-bind='value:data.stockingStrategy'></textarea></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel"><label>Comments / Notes:</label></span><textarea  class="span8" data-bind='value:data.notes'></textarea></span></div></div></div>
<div class="row-fluid output-section">
            <table class="table table-bordered stockingDetails " >
                <thead><tr><th class="required">Type of stock used:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Type of stock species being used to achieve the purpose of the activity'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th class="required">Stocking density (DSE / Ha):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The density of grazing stock used to achieve the purpose of the activity expressed in Dry Sheep Equivalents per hectare'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th></th>
                </tr></thead>
                <tbody data-bind="template:{name:'stockingDetailsviewTmpl', foreach: data.stockingDetails}"></tbody>
                <script id="stockingDetailsviewTmpl" type="text/html"><tr>
                    <td><select data-bind='value:stockingManagementSpecies,options:transients.stockingManagementSpeciesConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></td>
                    <td><input class="input-small" style="text-align:center" data-bind='value:stockingDensity' data-validation-engine='validate[required,custom[number],min[0]]' type='number' class='input-mini'/></td>
                    <td><i data-bind='click:$root.removestockingDetailsRow' class='icon-remove'></i></td>
                </tr></script>
                <tfoot>
                <tr><td colspan="0" style="text-align:left;">
                        <button type="button" class="btn btn-small" data-bind="click:addstockingDetailsRow">
                        <i class="icon-plus"></i> Add a row</button>
                        <button type="button" class="btn btn-small" data-bind="click:showstockingDetailsTableDataUpload"><i class="icon-upload"></i> Upload data for this table</button>


                    </td></tr>
<tr data-bind="visible:stockingDetailsTableDataUploadVisible"><td colspan="0">
                <div class="text-error text-left">
                    Note: Only valid exact scientific names will be matched and populated from the database (indicated by a green tick). Unmatched species will load, but will be indicated by a green <b>?</b>. Please check your uploaded data and correct as required.
                </div>
                <div class="text-left" style="margin:5px">
                    <a href="/fieldcapture/proxy/excelOutputTemplate?type=Stock Management Details&listName=stockingDetails" target="stockingDetailsTemplateDownload" class="btn">Step 1 - Download template (.xlsx)</a>
                </div>
                <div class="text-left" style="margin:5px;">
                    <input type="checkbox" data-bind="checked:appendTableRows" style="margin-right:5px">Append uploaded data to table (unticking this checkbox will result in all table rows being replaced)
                </div>

                <div class="btn fileinput-button" style="margin-left:5px">
                        <input id="stockingDetailsTableDataUpload" type="file" name="data" data-bind="fileUploadNoImage:stockingDetailsTableDataUploadOptions">
                        Step 2 - Upload populated template
                </div>

                    </td></tr> <script id="stockingDetailstemplate-upload" type="text/x-tmpl">{% %}</script>
                       <script id="stockingDetailstemplate-download" type="text/x-tmpl">{% %}</script>                </tfoot>
            </table>
        </div>

        
    </div>

    
    
    <style type="text/css">
        table.weedAbundanceAndThreatScore td:nth-child(1) {width:25%;}
        table.weedAbundanceAndThreatScore td:nth-child(1) select {width:100%;}
        table.weedAbundanceAndThreatScore td:nth-child(2) {width:8%;text-align:center;}
        table.weedAbundanceAndThreatScore td:nth-child(2) select {width:100%;}
        table.weedAbundanceAndThreatScore td:nth-child(3) {width:17%;text-align:center;}
        table.weedAbundanceAndThreatScore td:nth-child(3) select {width:100%;}
        table.weedAbundanceAndThreatScore td:nth-child(4) {width:10%;text-align:center;}
        table.weedAbundanceAndThreatScore td:nth-child(4) select {width:100%;}
        table.weedAbundanceAndThreatScore td:nth-child(5) {width:10%;text-align:center;}
        table.weedAbundanceAndThreatScore td:nth-child(5) select {width:100%;}
        table.weedAbundanceAndThreatScore td:nth-child(6) {width:10%;text-align:center;}
        table.weedAbundanceAndThreatScore td:nth-child(6) select {width:100%;}
        table.weedAbundanceAndThreatScore td:last-child {width:4%;text-align:center;}
        table.weedAbundanceAndThreatScore textarea {width:98%;}
    </style>
    <div class="output-block" id="koWeed_Abundance_&_Threat_Score">
        <h3 data-bind="css:{modified:dirtyFlag.isDirty},attr:{title:'Has been modified'}">Weed Abundance & Threat Score<i class="icon-asterisk modified-icon" data-bind="visible:dirtyFlag.isDirty" title="Has been modified" style="display: none;"></i></h3>
        <!-- add the dynamic components -->
        <div class="row-fluid ">
            <table class="table table-bordered weedAbundanceAndThreatScore " >
                <thead><tr><th>Weed name</th><th>Unknown if weed or native</th><th>% Area covered rating</th><th>Cover Rating</th><th>Invasive Threat Category</th><th>Abundance & Threat Score</th><th></th>
                </tr></thead>
                <tbody data-bind="template:{name:'weedAbundanceAndThreatScoreviewTmpl', foreach: data.weedAbundanceAndThreatScore}"></tbody>
                <script id="weedAbundanceAndThreatScoreviewTmpl" type="text/html"><tr>
                    <td>
<span class="input-prepend input-append" data-bind="with:species">
    <span class="add-on" data-bind="visible:!transients.editing(), css:{'btn-success':name()}"><i class="icon-white" data-bind="css:{'icon-ok':listId()!='unmatched' && name(), 'icon-question-sign':listId()=='unmatched'}"></i></span><span class="add-on" data-bind="visible:transients.editing()"><img src="/fieldcapture/static/Xo2jbaJ5EFqa59u9g4c4ybpCpw3wFWKhQdzZwNmmktO.gif" alt="saving icon" /></span><input type="text" data-bind="value:transients.textFieldValue,event:{focusout:focusLost},autocomplete:{url:'/fieldcapture/search/species', render: renderItem, listId: list, result:speciesSelected, valueChangeCallback:textFieldChanged}" />
    <span class="add-on" data-bind="visible: !transients.editing() && name()">
        <a href="#" data-bind="popover: {title: name, content: transients.speciesInformation}"><i class="icon-info-sign"></i></a>
    </span>
</span>
</td>
                    <td><input name='isUnknownIfWeed' data-bind='checked:isUnknownIfWeed' type='checkbox' class='checkbox'/></td>
                    <td><input class="input-small" style="text-align:center" data-bind='value:areaCovered' data-validation-engine='validate[custom[number],min[0]]' type='number' class='input-mini'/></td>
                    <td><input class="input-mini" style="text-align:center" data-bind='value:coverRating' data-validation-engine='validate[custom[number],min[0]]' type='number' class='input-mini'/></td>
                    <td><input class="input-mini" style="text-align:center" data-bind='value:invasiveThreatCategory' data-validation-engine='validate[custom[number],min[0]]' type='number' class='input-mini'/></td>
                    <td><input class="input-mini" style="text-align:center" data-bind='value:abundanceAndThreatScore' data-validation-engine='validate[custom[number],min[0]]' type='number' class='input-mini'/></td>
                    <td><i data-bind='click:$root.removeweedAbundanceAndThreatScoreRow' class='icon-remove'></i></td>
                </tr></script>
                <tfoot>
                <tr>
                    <td><span ></span></td>
                    <td><span >Total cover rating</span></td>
                    <td><input class="value input-small" style="text-align:center" data-bind='value:data.totalAreaCovered' data-validation-engine='validate[custom[number],min[0]]' type='number' class='input-mini'/></td>
                    <td colspan='2'><span >Total Abundance & Threat Score</span></td>
                    <td><span  class="value" data-bind='text:data.totalAbundanceAndThreatScore'></span></td>
                    <td></td>
                </tr>
                <tr><td colspan="7" style="text-align:left;">
                        <button type="button" class="btn btn-small" data-bind="click:addweedAbundanceAndThreatScoreRow">
                        <i class="icon-plus"></i> Add a row</button>
                        <button type="button" class="btn btn-small" data-bind="click:showweedAbundanceAndThreatScoreTableDataUpload"><i class="icon-upload"></i> Upload data for this table</button>


                    </td></tr>
<tr data-bind="visible:weedAbundanceAndThreatScoreTableDataUploadVisible"><td colspan="7">
                <div class="text-error text-left">
                    Note: Only valid exact scientific names will be matched and populated from the database (indicated by a green tick). Unmatched species will load, but will be indicated by a green <b>?</b>. Please check your uploaded data and correct as required.
                </div>
                <div class="text-left" style="margin:5px">
                    <a href="/fieldcapture/proxy/excelOutputTemplate?type=Weed Abundance & Threat Score&listName=weedAbundanceAndThreatScore" target="weedAbundanceAndThreatScoreTemplateDownload" class="btn">Step 1 - Download template (.xlsx)</a>
                </div>
                <div class="text-left" style="margin:5px;">
                    <input type="checkbox" data-bind="checked:appendTableRows" style="margin-right:5px">Append uploaded data to table (unticking this checkbox will result in all table rows being replaced)
                </div>

                <div class="btn fileinput-button" style="margin-left:5px">
                        <input id="weedAbundanceAndThreatScoreTableDataUpload" type="file" name="data" data-bind="fileUploadNoImage:weedAbundanceAndThreatScoreTableDataUploadOptions">
                        Step 2 - Upload populated template
                </div>

                    </td></tr> <script id="weedAbundanceAndThreatScoretemplate-upload" type="text/x-tmpl">{% %}</script>
                       <script id="weedAbundanceAndThreatScoretemplate-download" type="text/x-tmpl">{% %}</script>                </tfoot>
            </table>
        </div>
<div class="row-fluid space-after " >
<span class="heavy-border span5 offset4">    <span  class="span12">Your Weed Abundance & Threat Score</span></span><span class="heavy-border span1">    <span  data-bind='text:data.totalAbundanceAndThreatScore'></span></span></div>

        
    </div>

<!-- /ko -->

</div>




</div>

<script src="fieldcapture/static/DzazZ2ePykd4QRUJlInoAO1LMvzeVxjM2JRcis2usBm.js" type="text/javascript" ></script>



<script src="fieldcapture/static/gfz9yoFSoT3bDIgFJCbjPP9WLeFgekRHSp7KxcpYrwj.js" type="text/javascript" ></script>
<script src="fieldcapture/static/HpQC03jqzgdovdmQNni1bswagCkkBPaWGDIzgICGcvq.js" type="text/javascript" ></script>









<!--[if gte IE 8]><script src="fieldcapture/static/knxjs4G9Cquc79O3iYW107XikPB1Z1ii8QWrtBpzlSP.js" type="text/javascript" ></script><![endif]-->
<script src="fieldcapture/static/kSJb30BxnBzyoP0WndxrtZbaNWzT8x6LP2Cp7xI9PH4.js" type="text/javascript" ></script>
<script src="fieldcapture/static/N1Pu1Yy1dAP26vjRfEw0sZtbZhL03ir303dL4C7EaVF.js" type="text/javascript" ></script>

<script src="fieldcapture/static/NbeGWZssK95I6Y1Oz4lzxzRtDzf9dyFLZiTstPEonQa.js" type="text/javascript" ></script>
<script src="fieldcapture/static/L85LaBY6yhQwMk24PuXWgqwvtkfvbmMZ3ExPR9xK96.js" type="text/javascript" ></script>
<script src="fieldcapture/static/MZjUSqmNLHqbPwhDcAMpejU18pr9ndMRCGKpPBHdSDL.js" type="text/javascript" ></script>
<script src="fieldcapture/static/1nCsTsYbdgqupwL47F4n7c98ss299Uck5fAVxaO9UuE.js" type="text/javascript" ></script>





<script src="fieldcapture/static/7l2mDQFFpMnG14cXQPTKd94AN71T8yUF6dHUA2LCJIo.js" type="text/javascript" ></script>
<script src="fieldcapture/static/ZbrF5cz3bJrkAqBXLrAlOmoaIYntVDIKpviQs5E8Rhy.js" type="text/javascript" ></script>
<script src="fieldcapture/static/yzVPTi9KJTOMgo1ytEFVw7JiBXXkkbj5dU3cYZoIuS.js" type="text/javascript" ></script>

<script src="fieldcapture/static/IZCc6ZgD3MepYbz4UqlDLzMDNNghSCivcfGebmF9V2d.js" type="text/javascript" ></script>
<script type="text/javascript">
        $(function(){

            var viewModelName = "Revegetation_DetailsViewModel",
                viewModelInstance = viewModelName + "Instance";

            // load dynamic models - usually objects in a list
                    var PlantingRow = function (data) {
            var self = this;
            if (!data) data = {};
            self.transients = {};
            this.species =  new SpeciesViewModel(data['species'], speciesLists);
            this.numberPlanted = ko.observable(orZero(data['numberPlanted']));
            this.seedSownKg = ko.observable(orZero(data['seedSownKg']));
            this.stockType = ko.observable(orBlank(data['stockType']));
            self.transients.stockTypeConstraints = ["Seed","Tube","Advanced","Cutting","Other"];
            this.structuralLayer = ko.observable(orBlank(data['structuralLayer']));
            self.transients.structuralLayerConstraints = ["Overstory","Midstory","Understory","Ground stratum"];
            this.stockProvenance = ko.observable(orBlank(data['stockProvenance']));
            this.guardType = ko.observable(orBlank(data['guardType']));
            self.transients.guardTypeConstraints = ["None","Gro-guard","Carton","Other"];
        };
        var speciesLists = [];
        var site = {};


            this[viewModelName] = function (output) {
                var self = this;
                self.name = "Revegetation Details";
                self.outputId = "";
                self.data = {};
                self.transients = {};
                self.transients.dummy = ko.observable();

                // add declarations for dynamic data
            
            self.data.revegetationMethod = ko.observable();
            self.transients.revegetationMethodConstraints = ["Direct drill seeding","Hand broardcast seeding","Hand planting","Machine planting"];

            self.data.vegDescriptionAtPlanting = ko.observable();
            self.transients.vegDescriptionAtPlantingConstraints = ["Bare substrate","Exotic grassland/pasture","Native grassland/pasture","Sparse/scattered shrubland","Open grassy woodland","Other (specify in notes)"];

            self.data.equipmentUsed = ko.observable();

            self.data.adjacentLanduse = ko.observable();
            self.transients.adjacentLanduseConstraints = ["Conservation","Livestock","Cropping","Recreational","Rural","Residential","Industrial","Commercial or Business"];

            self.data.connectivityIndex = ko.observable();
            self.transients.connectivityIndexConstraints = ["Connected to patch of more than 1000 ha","Connected to patch of 100 to 1000 ha","Connected to patch of 25 to 100 ha","Connected to patch of less than 25 ha","Patch linked to other vegetation via riparian link","Isolated forest or woodland remnant","Patch surrounded by native grasses","Isolated grassland","No vegetation within 1km","Only isolated Paddock trees within 1 km","Patch surrounded by grazing","Patch surrounded by cropping"];
                self.data.environmentalBenefits=ko.observableArray([]);
            self.transients.environmentalBenefitsConstraints = ["Groundwater recharge management","Groundwater discharge or salinity management","Habitat restoration - home range improvement","Habitat enhancement - improved migration paths","Soil stabilisation","Riparian rehabilitation","Streambank protection","Nutrient cycling"];
                
        self.loadenvironmentalBenefits = function (data) {
            if (data !== undefined) {
                $.each(data, function (i, obj) {
                    self.data.environmentalBenefits.push(obj);
                });
        }};
        
            self.data.areaRevegHa = ko.observable();

            self.data.planting = ko.observableArray([]);
            self.selectedplantingRow = ko.observable();
        

            self.loadplanting = function (data, append) {
                if (!append) {
                    self.data.planting([]);
                }
                if (data === undefined) {
                    self.addplantingRow();
                } else {
                    $.each(data, function (i, obj) {
                        self.data.planting.push(new PlantingRow(obj));
                    });
                }
            };

            self.addplantingRow = function () {
                var newRow = new PlantingRow();
                self.data.planting.push(newRow);
                
            };
            self.removeplantingRow = function (row) {
                self.data.planting.remove(row);
                
            };
            self.plantingrowCount = function () {
                return self.data.planting().length;
            };

            self.plantingTableDataUploadVisible = ko.observable(false);
            self.showplantingTableDataUpload = function() {
                self.plantingTableDataUploadVisible(!self.plantingTableDataUploadVisible());
            };

            self.plantingTableDataUploadOptions = {
                    url:'/fieldcapture/activity/ajaxUpload',
                    done:function(e, data) {
                        if (data.result.error) {
                            self.uploadFailed(data.result.error);
                        }
                        else {
                            self.loadplanting(data.result.data, self.appendTableRows());
                        }
                    },
                    fail:function(e, data) {
                        var message = 'Please contact MERIT support and attach your spreadsheet to help us resolve the problem';
                        self.uploadFailed(data);

                    },
                    uploadTemplateId: "plantingtemplate-upload",
                    downloadTemplateId: "plantingtemplate-download",
                    formData:{type:'Revegetation Details', listName:'planting'}
            };
            self.appendTableRows = ko.observable(true);
            self.uploadFailed = function(message) {
                        var text = "<span class='label label-important'>Important</span><h4>There was an error uploading your data.</h4>";
                        text += "<p>"+message+"</p>";
                        bootbox.alert(text)
            };

            self.data.totalNumberPlanted = ko.computed(function () {
                var total = 0;
                for(var i = 0; i < self.data.planting().length; i++) {
                    var value = self.data.planting()[i].numberPlanted();
                        total = total + Number(value); 
                }
                return total;
            });

            self.data.totalSeedSownKg = ko.computed(function () {
                var total = 0;
                for(var i = 0; i < self.data.planting().length; i++) {
                    var value = self.data.planting()[i].seedSownKg();
                        total = total + Number(value); 
                }
                return total;
            });

            self.data.notes = ko.observable();
            self.transients.site = site;

            // this will be called when generating a savable model to remove transient properties
            self.removeBeforeSave = function (jsData) {
                // add code to remove any transients added by the dynamic tags
                            delete jsData.selectedplantingRow;
                delete jsData.plantingTableDataUploadOptions
                delete jsData.plantingTableDataUploadVisible

            delete jsData.activityType;
            delete jsData.transients;
            return jsData;
        };

        // this returns a JS object ready for saving
        self.modelForSaving = function () {
            // get model as a plain javascript object
            var jsData = ko.mapping.toJS(self, {'ignore':['transients']});
            // get rid of any transient observables
            return self.removeBeforeSave(jsData);
        };

        // this is a version of toJSON that just returns the model as it will be saved
        // it is used for detecting when the model is modified (in a way that should invoke a save)
        // the ko.toJSON conversion is preserved so we can use it to view the active model for debugging
        self.modelAsJSON = function () {
            return JSON.stringify(self.modelForSaving());
        };

        self.loadData = function (outputId, data) {
            self.outputId = outputId;
            // load dynamic data
                            self.data['revegetationMethod'](data['revegetationMethod']);
                self.data['vegDescriptionAtPlanting'](data['vegDescriptionAtPlanting']);
                self.data['equipmentUsed'](data['equipmentUsed']);
                self.data['adjacentLanduse'](data['adjacentLanduse']);
                self.data['connectivityIndex'](data['connectivityIndex']);
                self.loadenvironmentalBenefits(data['environmentalBenefits']);
                self.data['areaRevegHa'](orZero(data['areaRevegHa']));
                self.loadplanting(data.planting);
                self.data['notes'](data['notes']);


            // if there is no data in tables then add an empty row for the user to add data
            if (typeof self.addRow === 'function' && self.rowCount() === 0) {
                self.addRow();
            }
            self.transients.dummy.notifySubscribers();
        };
    };

    window[viewModelInstance] = new this[viewModelName]();
            window[viewModelInstance].dirtyFlag = ko.dirtyFlag(window[viewModelInstance], false);

            ko.applyBindings(window[viewModelInstance], document.getElementById("koRevegetation_Details"));

            // this resets the baseline for detecting changes to the model
            // - shouldn't be required if everything behaves itself but acts as a backup for
            //   any binding side-effects
            // - note that it is not foolproof as applying the bindings happens asynchronously and there
            //   is no easy way to detect its completion
            window[viewModelInstance].dirtyFlag.reset();

            // register with the master controller so this model can participate in the save cycle
            master.register(viewModelInstance, window[viewModelInstance].modelForSaving,
             window[viewModelInstance].dirtyFlag.isDirty, window[viewModelInstance].dirtyFlag.reset);

            // Check for locally saved data for this output - this will happen in the event of a session timeout
            // for example.
            var savedData = activity;
            if (!savedData.outputs) {
                savedData.outputs = [];
            }
            console.log(savedData);
            var savedOutput = null;
            var savedOutputId = null;
            if (savedData) {

                $.each(savedData.outputs, function(i, tmpOutput) {
                    if (tmpOutput.name === 'Revegetation Details') {
                        if (tmpOutput.data) {
                            savedOutput = tmpOutput.data;

                        }
                    }
                });
            }
            if (savedOutput) {
                window[viewModelInstance].loadData(savedOutputId, savedOutput);
            }
        });

        
        $(function(){

            var viewModelName = "Stock_Management_DetailsViewModel",
                viewModelInstance = viewModelName + "Instance";

            // load dynamic models - usually objects in a list
                    var StockingDetailsRow = function (data) {
            var self = this;
            if (!data) data = {};
            self.transients = {};
            this.stockingManagementSpecies = ko.observable(orBlank(data['stockingManagementSpecies']));
            self.transients.stockingManagementSpeciesConstraints = ["Cattle","Sheep","Horses","Goats","Llama / Alpaca","Other (specify in notes)"];
            this.stockingDensity = ko.observable(orZero(data['stockingDensity']));
            this.notes = ko.observable(orBlank(data['notes']));
        };
        var speciesLists = [];
        var site = {};


            this[viewModelName] = function (output) {
                var self = this;
                self.name = "Stock Management Details";
                self.outputId = "";
                self.data = {};
                self.transients = {};
                self.transients.dummy = ko.observable();

                // add declarations for dynamic data
                            self.data.stockManagementReason=ko.observableArray([]);
            self.transients.stockManagementReasonConstraints = ["Reduce competition & shading for revegetation areas","Promote woody plant growth","Reduce wildfire risk & intensity","Other (describe in notes)"];
                
        self.loadstockManagementReason = function (data) {
            if (data !== undefined) {
                $.each(data, function (i, obj) {
                    self.data.stockManagementReason.push(obj);
                });
        }};
        
            self.data.areaOfStockManagementHa = ko.observable();

            self.data.stockingStrategy = ko.observable();

            self.data.stockingDetails = ko.observableArray([]);
            self.selectedstockingDetailsRow = ko.observable();
        

            self.loadstockingDetails = function (data, append) {
                if (!append) {
                    self.data.stockingDetails([]);
                }
                if (data === undefined) {
                    self.addstockingDetailsRow();
                } else {
                    $.each(data, function (i, obj) {
                        self.data.stockingDetails.push(new StockingDetailsRow(obj));
                    });
                }
            };

            self.addstockingDetailsRow = function () {
                var newRow = new StockingDetailsRow();
                self.data.stockingDetails.push(newRow);
                
            };
            self.removestockingDetailsRow = function (row) {
                self.data.stockingDetails.remove(row);
                
            };
            self.stockingDetailsrowCount = function () {
                return self.data.stockingDetails().length;
            };

            self.stockingDetailsTableDataUploadVisible = ko.observable(false);
            self.showstockingDetailsTableDataUpload = function() {
                self.stockingDetailsTableDataUploadVisible(!self.stockingDetailsTableDataUploadVisible());
            };

            self.stockingDetailsTableDataUploadOptions = {
                    url:'/fieldcapture/activity/ajaxUpload',
                    done:function(e, data) {
                        if (data.result.error) {
                            self.uploadFailed(data.result.error);
                        }
                        else {
                            self.loadstockingDetails(data.result.data, self.appendTableRows());
                        }
                    },
                    fail:function(e, data) {
                        var message = 'Please contact MERIT support and attach your spreadsheet to help us resolve the problem';
                        self.uploadFailed(data);

                    },
                    uploadTemplateId: "stockingDetailstemplate-upload",
                    downloadTemplateId: "stockingDetailstemplate-download",
                    formData:{type:'Stock Management Details', listName:'stockingDetails'}
            };
            self.appendTableRows = ko.observable(true);
            self.uploadFailed = function(message) {
                        var text = "<span class='label label-important'>Important</span><h4>There was an error uploading your data.</h4>";
                        text += "<p>"+message+"</p>";
                        bootbox.alert(text)
            };
            self.transients.site = site;

            // this will be called when generating a savable model to remove transient properties
            self.removeBeforeSave = function (jsData) {
                // add code to remove any transients added by the dynamic tags
                            delete jsData.selectedstockingDetailsRow;
                delete jsData.stockingDetailsTableDataUploadOptions
                delete jsData.stockingDetailsTableDataUploadVisible

            delete jsData.activityType;
            delete jsData.transients;
            return jsData;
        };

        // this returns a JS object ready for saving
        self.modelForSaving = function () {
            // get model as a plain javascript object
            var jsData = ko.mapping.toJS(self, {'ignore':['transients']});
            // get rid of any transient observables
            return self.removeBeforeSave(jsData);
        };

        // this is a version of toJSON that just returns the model as it will be saved
        // it is used for detecting when the model is modified (in a way that should invoke a save)
        // the ko.toJSON conversion is preserved so we can use it to view the active model for debugging
        self.modelAsJSON = function () {
            return JSON.stringify(self.modelForSaving());
        };

        self.loadData = function (outputId, data) {
            self.outputId = outputId;
            // load dynamic data
                            self.loadstockManagementReason(data['stockManagementReason']);
                self.data['areaOfStockManagementHa'](orZero(data['areaOfStockManagementHa']));
                self.data['stockingStrategy'](data['stockingStrategy']);
                self.loadstockingDetails(data.stockingDetails);


            // if there is no data in tables then add an empty row for the user to add data
            if (typeof self.addRow === 'function' && self.rowCount() === 0) {
                self.addRow();
            }
            self.transients.dummy.notifySubscribers();
        };
    };

    window[viewModelInstance] = new this[viewModelName]();
            window[viewModelInstance].dirtyFlag = ko.dirtyFlag(window[viewModelInstance], false);

            ko.applyBindings(window[viewModelInstance], document.getElementById("koStock_Management_Details"));

            // this resets the baseline for detecting changes to the model
            // - shouldn't be required if everything behaves itself but acts as a backup for
            //   any binding side-effects
            // - note that it is not foolproof as applying the bindings happens asynchronously and there
            //   is no easy way to detect its completion
            window[viewModelInstance].dirtyFlag.reset();

            // register with the master controller so this model can participate in the save cycle
            master.register(viewModelInstance, window[viewModelInstance].modelForSaving,
             window[viewModelInstance].dirtyFlag.isDirty, window[viewModelInstance].dirtyFlag.reset);

            // Check for locally saved data for this output - this will happen in the event of a session timeout
            // for example.
            var savedData = activity;
            if (!savedData.outputs) {
                savedData.outputs = [];
            }
            console.log(savedData);
            var savedOutput = null;
            var savedOutputId = null;
            if (savedData) {

                $.each(savedData.outputs, function(i, tmpOutput) {
                    if (tmpOutput.name === 'Stock Management Details') {
                        if (tmpOutput.data) {
                            savedOutput = tmpOutput.data;

                        }
                    }
                });
            }
            if (savedOutput) {
                window[viewModelInstance].loadData(savedOutputId, savedOutput);
            }
        });

        
        $(function(){

            var viewModelName = "Weed_Abundance_&_Threat_ScoreViewModel",
                viewModelInstance = viewModelName + "Instance";

            // load dynamic models - usually objects in a list
                    var WeedAbundanceAndThreatScoreRow = function (data) {
            var self = this;
            if (!data) data = {};
            self.transients = {};
            this.species =  new SpeciesViewModel(data['species'], speciesLists);
            this.isUnknownIfWeed = ko.observable(orFalse(data['isUnknownIfWeed']));
            this.areaCovered = ko.observable(orZero(data['areaCovered']));
            this.coverRating = ko.observable(orZero(data['coverRating']));
            this.invasiveThreatCategory = ko.observable(orZero(data['invasiveThreatCategory']));
                    self.abundanceAndThreatScore = ko.computed(function () {
                        if (isNaN(Number(self.coverRating())) || isNaN(Number(self.invasiveThreatCategory()))) { return 0; }
                        return Number(self.coverRating()) * Number(self.invasiveThreatCategory());
                    });
        };
        var speciesLists = [];
        var site = {};


            this[viewModelName] = function (output) {
                var self = this;
                self.name = "Weed Abundance & Threat Score";
                self.outputId = "";
                self.data = {};
                self.transients = {};
                self.transients.dummy = ko.observable();

                // add declarations for dynamic data
            
            self.data.weedAbundanceAndThreatScore = ko.observableArray([]);
            self.selectedweedAbundanceAndThreatScoreRow = ko.observable();
        

            self.loadweedAbundanceAndThreatScore = function (data, append) {
                if (!append) {
                    self.data.weedAbundanceAndThreatScore([]);
                }
                if (data === undefined) {
                    self.addweedAbundanceAndThreatScoreRow();
                } else {
                    $.each(data, function (i, obj) {
                        self.data.weedAbundanceAndThreatScore.push(new WeedAbundanceAndThreatScoreRow(obj));
                    });
                }
            };

            self.addweedAbundanceAndThreatScoreRow = function () {
                var newRow = new WeedAbundanceAndThreatScoreRow();
                self.data.weedAbundanceAndThreatScore.push(newRow);
                
            };
            self.removeweedAbundanceAndThreatScoreRow = function (row) {
                self.data.weedAbundanceAndThreatScore.remove(row);
                
            };
            self.weedAbundanceAndThreatScorerowCount = function () {
                return self.data.weedAbundanceAndThreatScore().length;
            };

            self.weedAbundanceAndThreatScoreTableDataUploadVisible = ko.observable(false);
            self.showweedAbundanceAndThreatScoreTableDataUpload = function() {
                self.weedAbundanceAndThreatScoreTableDataUploadVisible(!self.weedAbundanceAndThreatScoreTableDataUploadVisible());
            };

            self.weedAbundanceAndThreatScoreTableDataUploadOptions = {
                    url:'/fieldcapture/activity/ajaxUpload',
                    done:function(e, data) {
                        if (data.result.error) {
                            self.uploadFailed(data.result.error);
                        }
                        else {
                            self.loadweedAbundanceAndThreatScore(data.result.data, self.appendTableRows());
                        }
                    },
                    fail:function(e, data) {
                        var message = 'Please contact MERIT support and attach your spreadsheet to help us resolve the problem';
                        self.uploadFailed(data);

                    },
                    uploadTemplateId: "weedAbundanceAndThreatScoretemplate-upload",
                    downloadTemplateId: "weedAbundanceAndThreatScoretemplate-download",
                    formData:{type:'Weed Abundance & Threat Score', listName:'weedAbundanceAndThreatScore'}
            };
            self.appendTableRows = ko.observable(true);
            self.uploadFailed = function(message) {
                        var text = "<span class='label label-important'>Important</span><h4>There was an error uploading your data.</h4>";
                        text += "<p>"+message+"</p>";
                        bootbox.alert(text)
            };

            self.data.totalAreaCovered = ko.observable();

            self.data.totalAbundanceAndThreatScore = ko.computed(function () {
                var total = 0;
                for(var i = 0; i < self.data.weedAbundanceAndThreatScore().length; i++) {
                    var value = self.data.weedAbundanceAndThreatScore()[i].abundanceAndThreatScore();
                        total = total + Number(value); 
                }
                return total;
            });
            self.transients.site = site;

            // this will be called when generating a savable model to remove transient properties
            self.removeBeforeSave = function (jsData) {
                // add code to remove any transients added by the dynamic tags
                            delete jsData.selectedweedAbundanceAndThreatScoreRow;
                delete jsData.weedAbundanceAndThreatScoreTableDataUploadOptions
                delete jsData.weedAbundanceAndThreatScoreTableDataUploadVisible

            delete jsData.activityType;
            delete jsData.transients;
            return jsData;
        };

        // this returns a JS object ready for saving
        self.modelForSaving = function () {
            // get model as a plain javascript object
            var jsData = ko.mapping.toJS(self, {'ignore':['transients']});
            // get rid of any transient observables
            return self.removeBeforeSave(jsData);
        };

        // this is a version of toJSON that just returns the model as it will be saved
        // it is used for detecting when the model is modified (in a way that should invoke a save)
        // the ko.toJSON conversion is preserved so we can use it to view the active model for debugging
        self.modelAsJSON = function () {
            return JSON.stringify(self.modelForSaving());
        };

        self.loadData = function (outputId, data) {
            self.outputId = outputId;
            // load dynamic data
                            self.loadweedAbundanceAndThreatScore(data.weedAbundanceAndThreatScore);
                self.data['totalAreaCovered'](orZero(data['totalAreaCovered']));


            // if there is no data in tables then add an empty row for the user to add data
            if (typeof self.addRow === 'function' && self.rowCount() === 0) {
                self.addRow();
            }
            self.transients.dummy.notifySubscribers();
        };
    };

    window[viewModelInstance] = new this[viewModelName]();
            window[viewModelInstance].dirtyFlag = ko.dirtyFlag(window[viewModelInstance], false);

            ko.applyBindings(window[viewModelInstance], document.getElementById("koWeed_Abundance_&_Threat_Score"));

            // this resets the baseline for detecting changes to the model
            // - shouldn't be required if everything behaves itself but acts as a backup for
            //   any binding side-effects
            // - note that it is not foolproof as applying the bindings happens asynchronously and there
            //   is no easy way to detect its completion
            window[viewModelInstance].dirtyFlag.reset();

            // register with the master controller so this model can participate in the save cycle
            master.register(viewModelInstance, window[viewModelInstance].modelForSaving,
             window[viewModelInstance].dirtyFlag.isDirty, window[viewModelInstance].dirtyFlag.reset);

            // Check for locally saved data for this output - this will happen in the event of a session timeout
            // for example.
            var savedData = activity;
            if (!savedData.outputs) {
                savedData.outputs = [];
            }
            console.log(savedData);
            var savedOutput = null;
            var savedOutputId = null;
            if (savedData) {

                $.each(savedData.outputs, function(i, tmpOutput) {
                    if (tmpOutput.name === 'Weed Abundance & Threat Score') {
                        if (tmpOutput.data) {
                            savedOutput = tmpOutput.data;

                        }
                    }
                });
            }
            if (savedOutput) {
                window[viewModelInstance].loadData(savedOutputId, savedOutput);
            }
        });

        


    /* Master controller for page. This handles saving each model as required. */
    var Master = function () {
        var self = this;
        this.subscribers = [];
        // client models register their name and methods to participate in saving
        self.register = function (modelInstanceName, getMethod, isDirtyMethod, resetMethod) {
            this.subscribers.push({
                model: modelInstanceName,
                get: getMethod,
                isDirty: isDirtyMethod,
                reset: resetMethod
            });
        };
        // master isDirty flag for the whole page - can control button enabling
        this.isDirty  = function () {
            var dirty = false;
            $.each(this.subscribers, function(i, obj) {
                dirty = dirty || obj.isDirty();
            });
            return dirty;
        };
        /**
         * Makes an ajax call to save any sections that have been modified. This includes the activity
         * itself and each output.
         *
         * Modified outputs are injected as a list into the activity object. If there is nothing to save
         * in the activity itself, then the root is an object that is empty except for the outputs list.
         *
         * NOTE that the model for each section must register itself to be included in this save.
         *
         * Validates the entire page before saving.
         */
        this.save = function () {

            var activityData, outputs = [];
            if ($('#validation-container').validationEngine('validate')) {
                $.each(this.subscribers, function(i, obj) {
                    if (obj.isDirty()) {
                        if (obj.model === 'activityModel') {
                            activityData = obj.get();
                        } else {
                            outputs.push(obj.get());
                        }
                    }
                });
                if (outputs.length === 0 && activityData === undefined) {
                    alert("Nothing to save.");
                    return;
                }
                if (activityData === undefined) { activityData = {}}
                activityData.outputs = outputs;

                var toSave = JSON.stringify(activityData);
                console.log("saving"+toSave);
                mobileBindings.saveActivity(toSave);

            }

        };

        this.reset = function () {
            $.each(this.subscribers, function(i, obj) {
                if (obj.isDirty()) {
                    obj.reset();
                }
            });
        };
    };

    if (mobileBindings == undefined) {
        var mobileBindings = {
        loadActivity:function(){return "{}"},
        saveActivity:function(){}
        };
    }
    var master = new Master();
    var activity = JSON.parse(mobileBindings.loadActivity());
    var themes = ['theme1', 'theme2'];

    var site = {};


    $(function(){

        console.log("Blah!");

        $('#validation-container').validationEngine('attach', {scroll: false});

        $('.helphover').popover({animation: true, trigger:'hover'});

        $('#reset').click(function () {
            master.reset();
        });


        ko.bindingHandlers.editOutput = {
            init: function(element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
                var outputName = ko.utils.unwrapObservable(valueAccessor()),
                    activity = bindingContext.$root,
                    outputId;

                // search for corresponding outputs in the activity data
                $.each(activity.outputs, function (i,output) { // iterate output data in the activity to
                                                                  // find any matching the meta-model name
                    if (output.name === outputName) {
                        outputId = output.outputId;
                    }
                });
                if (outputId) {
                    // build edit link
                    $(element).html('Edit data');
                    $(element).attr('href', fcConfig.serverUrl + "/output/edit/" + outputId +
                        "?returnTo=" + here);
                } else {
                    // build create link
                    $(element).attr('href', fcConfig.serverUrl + '/output/create?activityId=' + activity.activityId +
                        '&outputName=' + encodeURIComponent(outputName) +
                        "&returnTo=" + here);
                }
            }
        };

        function ViewModel (act, site) {
            var self = this;
            self.activityId = act.activityId;
            self.description = ko.observable(act.description);
            self.notes = ko.observable(act.notes);
            self.startDate = ko.observable(act.startDate).extend({simpleDate: false});
            self.endDate = ko.observable(act.endDate || act.plannedEndDate).extend({simpleDate: false});
            self.plannedStartDate = ko.observable(act.plannedStartDate).extend({simpleDate: false});
            self.plannedEndDate = ko.observable(act.plannedEndDate).extend({simpleDate: false});
            self.eventPurpose = ko.observable(act.eventPurpose);
            self.fieldNotes = ko.observable(act.fieldNotes);
            self.associatedProgram = ko.observable(act.associatedProgram);
            self.associatedSubProgram = ko.observable(act.associatedSubProgram);
            self.progress = ko.observable(act.progress);
            self.mainTheme = ko.observable(act.mainTheme);
            self.type = ko.observable(act.type);
            self.siteId = ko.observable(act.siteId);
            self.projectId = act.projectId;
            self.transients = {};
            self.transients.site = site;
            self.transients.activityProgressValues = ['planned','started','finished'];
            self.transients.themes = themes;
            self.transients.markedAsFinished = ko.observable(act.progress === 'finished');
            self.transients.markedAsFinished.subscribe(function (finished) {
                self.progress(finished ? 'finished' : 'started');
            });

            self.modelForSaving = function () {
                // get model as a plain javascript object
                var jsData = ko.toJS(self);
                delete jsData.transients;
                return jsData;
            };
            self.modelAsJSON = function () {
                return JSON.stringify(self.modelForSaving());
            };

            self.save = function (callback, key) {
            };

            self.notImplemented = function () {
                alert("Not implemented yet.")
            };
            self.dirtyFlag = ko.dirtyFlag(self, false);

            // make sure progress moves to started if we save any data (unless already finished)
            // (do this here so the model becomes dirty)
            self.progress(self.transients.markedAsFinished() ? 'finished' : 'started');
        }


        var viewModel = new ViewModel(activity, site);

        ko.applyBindings(viewModel);

        master.register('activityModel', viewModel.modelForSaving, viewModel.dirtyFlag.isDirty, viewModel.dirtyFlag.reset);

        var mapFeatures = $.parseJSON('');
        if(mapFeatures !=null && mapFeatures.features !== undefined && mapFeatures.features.length >0){
            init_map_with_features({
                    mapContainer: "smallMap",
                    zoomToBounds:true,
                    zoomLimit:16,
                    featureService: "/fieldcapture/proxy/feature",
                    wmsServer: "http://spatial-dev.ala.org.au/geoserver"
                },
                mapFeatures
            );
        }
    });
</script>
</body>
</html>
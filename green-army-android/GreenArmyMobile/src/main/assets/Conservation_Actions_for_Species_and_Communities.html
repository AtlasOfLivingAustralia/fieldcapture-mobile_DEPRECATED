

<!DOCTYPE html>
<head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <script src="static/t5OGphSUjwdNOoxNKgdRTTh1RBtmzhMXxHDYYeR4lYj.js" type="text/javascript" ></script>
<link href="static/090onaZX1M508oSWqGmMeETZ9NkUA9p4CCTW3MUpRPc.css" type="text/css" rel="stylesheet" media="screen, projection" />

<link href="static/VySgOjkVOsD8Jt8ujXROVRjZeDLAAwVhMF5WqPZ8Ajf.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="http://www.ala.org.au/wp-content/themes/ala2011/images/favicon.ico" rel="shortcut icon" />
<!--[if lt IE 9]><script src="static/Yh1Txee3hFzExJ4P1str7tGV24zQMEYtxqtlYJ5ukR0.js" type="text/javascript" ></script><![endif]-->
<link href="static/Qwaw257M4sHcJuspEDRbeQoTceByqRmOCHNaZWpOxuc.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="static/AcXIjLTuc87n8sfxBjJRQSoBIUwP9RnCyK8Sv82i7eV.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="static/doSKUivnfI9gXmPKZ2XG4W5xIABYgKaf5Dwf3LtjNVr.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="static/fx5pGfEFSRJi6nyez3s8fUsjDL8WJ0IB04Njm7T2VAJ.css" type="text/css" rel="stylesheet" media="all" />
<link href="static/qBQAxqnczDqd7Bl7B2gXgLoB51xIPPVo3q06lXUPLcy.css" type="text/css" rel="stylesheet" media="screen,print" />




<link href="static/KYGDEVRRaKjNbTXJkHmicmzo9vFrnnzCnGLcxKjR04f.css" type="text/css" rel="stylesheet" media="screen,print" />

<link href="static/KtHosYDw6qHDklqhUqI9Y0lrV4QlbtokVSWtoN5CyvP.css" type="text/css" rel="stylesheet" media="screen,print" />
<link href="static/nq5UnIyX5LhMaOWVShAJhQHKHVGPAbNeKmoHiJNIGvz.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="/static/RrjzrZ0Ci0GPLETIr8x8KUMjfJtZKvifrUtMCedwKRB.png" rel="shortcut icon" />
<link href="static/4zsVqykqBON8U5Es5kfffXBSGJlbI8VrPDW4hSn1SWJ.css" type="text/css" rel="stylesheet" media="screen, projection" />


<link href="static/sCFm7bBsIMFGQHTSlBbhMHQCXWhOsbBr5z4bu1OueIE.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="static/tUELnv7Uvq6ppWNUWOlaow3JGSTTIf8hJ2VYvh7Oahj.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="/static/OKcRcjAeA1yuXD9r4fZA1Uw2HEwL7gYvjc6HdrZXIYP.png" rel="shortcut icon" />
<link href="/static/UxF0saaqmikaj74l2WFcCyPMm9hEEs8if7IBy0GNAnd.png" rel="shortcut icon" />
<link href="/static/zs4hrJqt7I802RlaZiXbmbDBarpNPZF8V8fCQJ2RVTM.png" rel="shortcut icon" />
<link href="/static/SvC1e8bSiCPFh8mObbEThgbJIaGZi72ATzqobK6QnnB.gif" rel="shortcut icon" />
<link href="/static/BA9MhIHZnH0zMcKJWIWsTurHhQTpDYE6akqM5excaZI.gif" rel="shortcut icon" />

<script type="text/javascript">
    var fcConfig = {
        bieUrl: "http://bie.ala.org.au",
        speciesProfileUrl: "https://fieldcapture.ala.org.au/proxy/speciesProfile",
        googleStaticUrl:"http://maps.googleapis.com/maps/api/staticmap?maptype=terrian&zoom=12&sensor=false&size=350x250&markers=color:red%7C"
        },
        here = document.location.href;
    </script>
    

    <meta name="layout" content="mobile"/>

    
    
    
</if>

    <style type="text/css">
        input[type=checkbox] {  -webkit-transform: scale(1.5); }
        .checkbox-list label { min-height: 40px; }
        .speciesAutocompleteRow {min-height:40px;}
        .datepicker td, .datepicker th {
            width:40px;
            height:40px;
            vertical-align: middle;
        }
    </style>
</head>

<body>

<div id="content" class="clearfix">
    
<div class="container-fluid validationEngineContainer" id="validation-container">
<div id="koActivityMainBlock">

    <div class="row-fluid">
        <div class="span12">
            <!-- Common activity fields -->

            <div class="row-fluid space-after">
                <div class="span4">

                    <label class="for-readonly">Type</label>
                    <span class="readonly-text" data-bind="text:type"></span>
                </div>
                <div class="span8">

                    <label class="for-readonly">Description</label>
                    <span class="readonly-text" data-bind="text:description"></span>
                </div>
            </div>


            <div class="row-fluid space-after">
                <div class="span4">
                    <label class="for-readonly inline">Planned start date</label>
                    <span class="readonly-text" data-bind="text:plannedStartDate.formattedDate"></span>
                </div>
                <div class="span8">
                    <label class="for-readonly inline">Planned end date</label>
                    <span class="readonly-text" data-bind="text:plannedEndDate.formattedDate"></span>
                </div>
            </div>

            <div class="well">
                <div class="row-fluid">

                    <span class="span8">
                    <div class="row-fluid space-after">

                        <div class="span6 required">
                            <label for="startDate"><b>Actual start date</b>
                                <a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Date the activity was started.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a>
                            </label>


                            <div class="input-append">
                                <input data-bind='datepicker:startDate.date' name='startDate' id='startDate' type='text' size='16' class='input-xlarge' readonly='readonly' targetField='startDate.date' data-validation-engine='validate[required]' />
<span class='add-on open-datepicker'>
  <i class='icon-th'>&nbsp;</i>
</span>
                            </div>

                        </div>
                        <div class="span6" data-bind="css:{required:transients.markedAsFinished}">
                            <label for="endDate"><b>Actual end date</b>
                                <a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Date the activity finished.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a>
                            </label>

                            <div class="input-append">
                                <input data-bind='datepicker:endDate.date' name='endDate' id='endDate' type='text' size='16' class='input-xlarge' readonly='readonly' targetField='endDate.date' data-validation-engine='validate[future[startDate]]' />
<span class='add-on open-datepicker'>
  <i class='icon-th'>&nbsp;</i>
</span>
                            </div>

                        </div>
                    </div>
                    <div class="row-fluid space-after">
                        <div class="span6">
                            <label for="theme"><b>Major theme</b></label>
                            <select id="theme" data-bind="value:mainTheme, options:transients.themes, optionsCaption:'Choose..'" class="input-xlarge" style="width:90%">
                            </select>
                        </div>

                        <div class="span6">
                            <label><b>Progress</b></label>
                            <label for="activityComplete"><input type="checkbox" id="activityComplete" data-bind="checked:transients.markedAsFinished" style="margin-right:1em;"><span>This activity is complete</span></label>

                        </div>

                    </div>
                    <div class="row-fluid">
                        <div class="span6">
                            <label for="site"><b>Site</b></label>
                            <select id='site' style='width:90%' data-bind='options:transients.sites,optionsText:"name",optionsValue:"siteId",value:siteId,optionsCaption:"Choose a site..."'>&nbsp;</select>

                        </div>

                        <div class="span3">

                            <button class="btn btn-info" style="margin-top:25px;" data-bind="visible:transients.newSiteSupported,click:createNewSite">Create new Site</button>
                        </div>
                    </div>

                    
                        
                            
                                
                            
                            
                                
                                    
                                    
                                    
                                    

                                
                            
                        

                    
                    </span>
                    <span class="span4">

                        <img id="siteLocationImage" width="100%" data-bind="event:{error:siteLoadError}, attr:{src:transients.siteImgUrl}, visible:transients.siteImgUrl()"/>


                    </span>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ko stopBinding: true -->

    
    
    
    <style type="text/css">
        table.conservationWorks th {white-space:normal;}
        table.conservationWorks tbody td:nth-child(1) {width:80%;}
        table.conservationWorks tbody td:nth-child(2) {width:18%;text-align:center;}
        table.conservationWorks td:last-child {width:4%;text-align:center;}
        table.conservationWorks textarea {width:100%; box-sizing:border-box; }
        table.conservationWorks select {width:100%; box-sizing:border-box; }
    </style><style type="text/css">
        table.protectionMechanisms th {white-space:normal;}
        table.protectionMechanisms tbody td:nth-child(1) {width:65%;}
        table.protectionMechanisms tbody td:nth-child(2) {width:18%;text-align:center;}
        table.protectionMechanisms tbody td:nth-child(3) {width:18%;text-align:center;}
        table.protectionMechanisms td:last-child {width:4%;text-align:center;}
        table.protectionMechanisms textarea {width:100%; box-sizing:border-box; }
        table.protectionMechanisms select {width:100%; box-sizing:border-box; }
    </style>
    <div class="output-block" id="koConservation_Works_Details">
            <h3 data-bind="css:{modified:dirtyFlag.isDirty},attr:{title:'Has been modified'}">Conservation Works Details</h3>
        <div data-bind="if:transients.optional">
            <label class="checkbox" ><input type="checkbox" data-bind="checked:outputNotCompleted"> <span data-bind="text:transients.questionText"></span> </label>
        </div>
        <div id="Conservation_Works_Details-content" data-bind="visible:!outputNotCompleted()">
        <!-- add the dynamic components -->
            <div class="row-fluid space-after output-section" >
<span class="span3">    <span  class="preLabel"><label>Species:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Species targeted for these conservation works / measures (start typing a  scientific or common name for a species)'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span>
<span class="input-prepend input-append" data-bind="with:data.targetSpecies">
    <span class="add-on" data-bind="visible:!transients.editing(), css:{'btn-success':name()}"><i class="icon-white" data-bind="css:{'icon-ok':listId()!='unmatched' && name(), 'icon-question-sign':listId()=='unmatched' || listId() == 'error-unmatched'}"></i></span><span class="add-on" data-bind="visible:transients.editing()"><img src="static/Xo2jbaJ5EFqa59u9g4c4ybpCpw3wFWKhQdzZwNmmktO.gif" alt="saving icon" /></span><input type="text" data-bind="value:transients.textFieldValue,event:{focusout:focusLost},autocomplete:{url:'https://fieldcapture.ala.org.au/search/species', render: renderItem, listId: list, result:speciesSelected, valueChangeCallback:textFieldChanged}" />
    <span class="add-on" data-bind="visible: !transients.editing() && name()">
        <a href="#" data-bind="popover: {title: name, content: transients.speciesInformation}"><i class="icon-info-sign"></i></a>
    </span>
</span>
</span><span class="span3">    <span  class="preLabel"><label>Threatened Ecological Community:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Threatened Ecological Community targeted for these conservation works / measures'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><select class="span12" data-bind='value:data.targetTEC,options:transients.targetTECConstraints,optionsCaption:"Please select"'></select></span><span class="span3">    <span  class="preLabel"><label>No. of animals in captive breeding programs or plants propagated:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of individual animals in a captive or ex-situ breeding program or plants in a propagation program.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.animalBreedingNos' data-validation-engine='validate[min[0],custom[number]]' type='number' class='input-mini'/></span><span class="span3">    <span  class="preLabel"><label>No. of animals / plants released back into the wild:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of individual animals / plants released back into the wild'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.animalReleaseNumber' data-validation-engine='validate[min[0],custom[number]]' type='number' class='input-mini'/></span></div>
<div class="row-fluid output-section">
            <table class="table table-bordered conservationWorks " >
                <thead><tr><th>Conservation Action:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The type of conservation works implemented'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th>Area impacted by works (Ha):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Area in hectares impacted by the conservation works'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th></th>
                </tr></thead>
                <tbody data-bind="template:{name:'conservationWorksviewTmpl', foreach: data.conservationWorks}"></tbody>
                <script id="conservationWorksviewTmpl" type="text/html"><tr>
                    <td><select data-bind='value:conservationActionType,options:transients.conservationActionTypeConstraints,optionsCaption:"Please select"'></select></td>
                    <td><input class="input-small" style="text-align:center" data-bind='value:areaImpactedByWorks' data-validation-engine='validate[min[0],custom[number]]' type='number' class='input-mini'/></td>
                    <td><i data-bind='click:$root.removeconservationWorksRow' class='icon-remove'></i></td>
                </tr></script>
                <tfoot>
                <tr>
                    <td colspan='2'><span ><i>If this table is not relevant to the activities you completed, please delete the table row using the <i class='fa fa-cross'></i> icon in the rightmost column</i></span></td>
                    <td></td>
                </tr>
                <tr><td colspan="3" style="text-align:left;">
                        <button type="button" class="btn btn-small" data-bind="click:addconservationWorksRow">
                        <i class="icon-plus"></i> Add a row</button></td></tr> <script id="conservationWorkstemplate-upload" type="text/x-tmpl">{% %}</script>
                       <script id="conservationWorkstemplate-download" type="text/x-tmpl">{% %}</script>                </tfoot>
            </table>
        </div>
<div class="row-fluid output-section">
            <table class="table table-bordered protectionMechanisms " >
                <thead><tr><th class="required">Type of Agreement mechanism:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The type of agreement mechanism implemented to protect threatened species'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th class="required">No. of Agreement mechanisms:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of agreement mechanisms implemented as a result of the project'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th class="required">Area under Agreement (Ha):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Area covered by conservation agreement (Ha):'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th></th>
                </tr></thead>
                <tbody data-bind="template:{name:'protectionMechanismsviewTmpl', foreach: data.protectionMechanisms}"></tbody>
                <script id="protectionMechanismsviewTmpl" type="text/html"><tr>
                    <td><select data-bind='value:protectionMechanism,options:transients.protectionMechanismConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></td>
                    <td><input class="input-small" style="text-align:center" data-bind='value:numberOfProtectionMechanisms' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></td>
                    <td><input class="input-small" style="text-align:center" data-bind='value:areaUnderAgreement' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></td>
                    <td><i data-bind='click:$root.removeprotectionMechanismsRow' class='icon-remove'></i></td>
                </tr></script>
                <tfoot>
                <tr>
                    <td colspan='3'><span ><i>If this table is not relevant to the activities you completed, please delete the table row using the <i class='fa fa-cross'></i> icon in the rightmost column</i></span></td>
                    <td></td>
                </tr>
                <tr><td colspan="4" style="text-align:left;">
                        <button type="button" class="btn btn-small" data-bind="click:addprotectionMechanismsRow">
                        <i class="icon-plus"></i> Add a row</button></td></tr> <script id="protectionMechanismstemplate-upload" type="text/x-tmpl">{% %}</script>
                       <script id="protectionMechanismstemplate-download" type="text/x-tmpl">{% %}</script>                </tfoot>
            </table>
        </div>
<div class="row-fluid space-after output-section" >
<span class="span12">    <span  class="preLabel"><label>Comments / Notes:</label></span><textarea  class="span12" data-bind='value:data.notes'></textarea></span></div>
<div class="row-fluid space-after output-section" >
<span class="span12">    <span  class="span12"><h4>Please attach applicable Plan documents via Admin tab</h4></span></span></div>

        </div>
        


        
    </div>
    

    
    
    
    
    <div class="output-block" id="koParticipant_Information">
            <h3 data-bind="css:{modified:dirtyFlag.isDirty},attr:{title:'Has been modified'}">Participant Information</h3>
        <div data-bind="if:transients.optional">
            <label class="checkbox" ><input type="checkbox" data-bind="checked:outputNotCompleted"> <span data-bind="text:transients.questionText"></span> </label>
        </div>
        <div id="Participant_Information-content" data-bind="visible:!outputNotCompleted()">
        <!-- add the dynamic components -->
            <div class="row-fluid space-after output-section" >
<div class="span4">
<div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Total no. of participants (ie. not employed on project):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The total number of people involved in an activity who are not delivery partners or employed in the project. These would typically be the volunteer participants and/or event attendees.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.totalParticipantsNotEmployed' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>No. of Indigenous participants (ie. not employed on project):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of indigenous people participating in an activity who are not delivery partners or employed in the project (ie. Indigenous volunteers)'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.numberOfIndigenousParticipants' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span></div></div><div class="span4">
<div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>No. of new people attending project activities:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of people involved in an activity who have not attended other activities associated with the project'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.totalParticipantsNew' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>No. of farming entities participating in project activities for the first time:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='A farming entity is a farm business (whether sole trader, partnership, company, etc.) that would be considered a primary producer for tax purposes.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.numberOfFarmingEntitiesNew' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span></div></div><div class="span4">
<div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>No. of community groups (non delivery partners) participating:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of different community groups (non delivery partners) participating in this activity'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.numberOfCommunityGroups' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>No. of Indigenous on-country visits:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of unique indigenous on-country visits undertaken as part of this activity'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.numberOnCountryVisits' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span></div></div></div>

        </div>
        


        
    </div>
    

<!-- /ko -->

</div>




</div>

<script src="static/jNGzWep9YTzJQCsSRDWGKonJ7ycvNMNQauAe6AcGX4T.js" type="text/javascript" ></script>





<script src="static/5zeDycYZFxJsfDd3W1kuhrN47XnIMrbhS6gdHDvcExv.js" type="text/javascript" ></script>

<script src="static/ulxBmo4RrKTNT3DuFHethb4EOZpwQfvefxNXivDIbzp.js" type="text/javascript" ></script>








<!--[if gte IE 8]><script src="static/knxjs4G9Cquc79O3iYW107XikPB1Z1ii8QWrtBpzlSP.js" type="text/javascript" ></script><![endif]-->
<script src="static/nRrltgvxdEHd5BqRR1v4XU3ZStOrhDScuH03g4r8E6O.js" type="text/javascript" ></script>

<script src="static/iRQrJhH2zDlUTI4nXr10v5JHksIJyPjoe8fHSE4QZcI.js" type="text/javascript" ></script>

<script src="static/NsIfUsVWId7YD36PcnVeycNW6GCdIRgD7cdnhiQldmM.js" type="text/javascript" ></script>









<script src="static/IZCc6ZgD3MepYbz4UqlDLzMDNNghSCivcfGebmF9V2d.js" type="text/javascript" ></script>
<script src="static/NwE7QStklZyP86Oe5o9TUAwbaHqgfflXARrIBoL6Q5s.js" type="text/javascript" ></script>




<script src="static/e9gGniNN5cG3OR4oPVWd5lYoxE5Xf282hFe7d4FTQbq.js" type="text/javascript" ></script>


<script src="static/CRNxISj7t7ZCV7B8M8dFtBK7x7R4tGVO36INoBz8gQX.js" type="text/javascript" ></script>

<script src="static/QhlSgFWjl35vcaCRa5cKxHZxRWSSluzptQUKz3PHr9s.js" type="text/javascript" ></script>


<script src="static/8WCQyXwicnBgTdLQ4F5jUFtmVXmqG9eUZKvo74wOnIT.js" type="text/javascript" ></script>
<script src="static/9HtLc6nfgO9H72LVVZxetW45ZR623Fx8EhEdydgOq2F.js" type="text/javascript" ></script>
<script src="static/wkrwT3eqoZlWXFPCQRTvkdsdvwzT5Lw2H89f9eTkQdb.js" type="text/javascript" ></script>


<script type="text/javascript">
    
    // load dynamic models - usually objects in a list
            var Output_ConservationWorksforThreatenedspecies_conservationWorksRow = function (data) {
            var self = this;
            if (!data) data = {};
            self.transients = {};
            this.conservationActionType = ko.observable(orBlank(data['conservationActionType']));
            self.transients.conservationActionTypeConstraints = ["Ecological thinning","Installation of nest boxes or other breeding/refuge structures","Restoring niche habitats","Seed bank establishment","Ex-situ breeding / propagation program","Other (specify in notes)"];
            this.areaImpactedByWorks = ko.observable(orZero(data['areaImpactedByWorks'])).extend({numericString:2});
        };
        var Output_ConservationWorksforThreatenedspecies_protectionMechanismsRow = function (data) {
            var self = this;
            if (!data) data = {};
            self.transients = {};
            this.protectionMechanism = ko.observable(orBlank(data['protectionMechanism']));
            self.transients.protectionMechanismConstraints = ["On title in perpetuity (eg Covenant Agreement)","Binding agreement not on title in perpetuity (eg Property Vegetation Plan)","Termed agreement not on title - binding (eg Land management agreement)","Not on title - non-binding (eg Wildlife Refuge)","No protection mechanism applicable","Other (specify in notes)"];
            this.numberOfProtectionMechanisms = ko.observable(orZero(data['numberOfProtectionMechanisms'])).extend({numericString:2});
            this.areaUnderAgreement = ko.observable(orZero(data['areaUnderAgreement'])).extend({numericString:2});
        };
        var speciesLists = [];
        var site = {};


    window["ViewModel"] = function (output, site, config) {
        var self = this;
        if (!output) {
            output = {};
        }
        var activityId = output.activityId || config.activityId || '';
        self.name = "";
        self.outputId = orBlank(output.outputId);

        self.data = {};
        self.transients = {};
        var notCompleted = output.outputNotCompleted;

        if (notCompleted === undefined) {
            notCompleted = config.collapsedByDefault;
        }

        self.transients.selectedSite = ko.observable(site);
        self.outputNotCompleted = ko.observable(notCompleted);
        self.transients.optional = config.optional || false;
        self.transients.questionText = config.optionalQuestionText || 'Not applicable';
        self.transients.dummy = ko.observable();

        self.downloadDataTemplate = function(listName) {
            var data = ko.mapping.toJS(self.data[listName](), {ignore:['transients']});
            var params = {
                listName:listName,
                type:self.name,
                data:JSON.stringify(data)
            };
            var url = '/activity/excelOutputTemplate';
            $.fileDownload(url, {
                httpMethod:'POST',
                data:params
            });

        };


        // add declarations for dynamic data
                    self.data.targetSpecies = new SpeciesViewModel({}, speciesLists, {printable:''});

            self.data.targetTEC = ko.observable();
            self.transients.targetTECConstraints = ["Alpine Sphagnum Bogs and Associated Fens","Aquatic Root Mat Community 1 in Caves of the Leeuwin Naturaliste Ridge","Aquatic Root Mat Community 2 in Caves of the Leeuwin Naturaliste Ridge","Aquatic Root Mat Community 3 in Caves of the Leeuwin Naturaliste Ridge","Aquatic Root Mat Community 4 in Caves of the Leeuwin Naturaliste Ridge","Aquatic Root Mat Community in Caves of the Swan Coastal Plain","Arnhem Plateau Sandstone Shrubland Complex","Assemblages of plants and invertebrate animals of tumulus (organic mound) springs of the Swan Coastal Plain","Blue Gum High Forest of the Sydney Basin Bioregion","Brigalow (Acacia harpophylla dominant and co-dominant)","Broad leaf tea-tree (Melaleuca viridiflora) woodlands in high rainfall coastal north Queensland","Buloke Woodlands of the Riverina and Murray-Darling Depression Bioregions","Castlereagh Scribbly Gum and Agnes Banks Woodlands of the Sydney Basin Bioregion","Central Hunter Valley eucalypt forest and woodland","Claypans of the Swan Coastal Plain","Coastal Upland Swamps in the Sydney Basin Bioregion","Cooks River/Castlereagh Ironbark Forest of the Sydney Basin Bioregion","Coolibah - Black Box Woodlands of the Darling Riverine Plains and the Brigalow Belt South Bioregions","Corymbia calophylla - Kingia australis woodlands on heavy soils of the Swan Coastal Plain","Corymbia calophylla - Xanthorrhoea preissii woodlands and shrublands of the Swan Coastal Plain","Cumberland Plain Shale Woodlands and Shale-Gravel Transition Forest","Eastern Stirling Range Montane Heath and Thicket","Eastern Suburbs Banksia Scrub of the Sydney Region","Eucalypt Woodlands of the Western Australian Wheatbelt","Eucalyptus ovata - Callitris oblonga Forest","Eyre Peninsula Blue Gum (Eucalyptus petiolaris) Woodland","Giant Kelp Marine Forests of South East Australia","Gippsland Red Gum (Eucalyptus tereticornis subsp. mediana) Grassy Woodland and Associated Native Grassland","Grassy Eucalypt Woodland of the Victorian Volcanic Plain","Grey Box (Eucalyptus microcarpa) Grassy Woodlands and Derived Native Grasslands of South-eastern Australia","Hunter Valley Weeping Myall (Acacia pendula) Woodland","Iron-grass Natural Temperate Grassland of South Australia","Kangaroo Island Narrow-leaved Mallee (Eucalyptus cneorifolia) Woodland","Littoral Rainforest and Coastal Vine Thickets of Eastern Australia","Lowland Grassy Woodland in the South East Corner Bioregion","Lowland Native Grasslands of Tasmania","Lowland Rainforest of Subtropical Australia","Mabi Forest (Complex Notophyll Vine Forest 5b)","Monsoon vine thickets on the coastal sand dunes of Dampier Peninsula","Natural Damp Grassland of the Victorian Coastal Plains","Natural Grasslands of the Murray Valley Plains","Natural Grasslands of the Queensland Central Highlands and the northern Fitzroy Basin","Natural grasslands on basalt and fine-textured alluvial plains of northern New South Wales and southern Queensland","Natural Temperate Grassland of the South Eastern Highlands","Natural Temperate Grassland of the Victorian Volcanic Plain","New England Peppermint (Eucalyptus nova-anglica) Grassy Woodlands","Peppermint Box (Eucalyptus odorata) Grassy Woodland of South Australia","Perched Wetlands of the Wheatbelt region with extensive stands of living sheoak and paperbark across the lake floor (Toolibin Lake)","Posidonia australis seagrass meadows of the Manning-Hawkesbury ecoregion","Proteaceae Dominated Kwongkan Shrublands of the Southeast Coastal Floristic Province of Western Australia","Scott River Ironstone Association","Seasonal Herbaceous Wetlands (Freshwater) of the Temperate Lowland Plains","Sedgelands in Holocene dune swales of the southern Swan Coastal Plain","Semi-evergreen vine thickets of the Brigalow Belt (North and South) and Nandewar Bioregions","Shale Sandstone Transition Forest of the Sydney Basin Bioregion","Shrublands and Woodlands of the eastern Swan Coastal Plain","Shrublands and Woodlands on Muchea Limestone of the Swan Coastal Plain","Shrublands and Woodlands on Perth to Gingin ironstone (Perth to Gingin ironstone association) of the Swan Coastal Plain","Shrublands on southern Swan Coastal Plain ironstones","Silurian Limestone Pomaderris Shrubland of the South East Corner and Australian Alps Bioregions","Southern Highlands Shale Forest and Woodland in the Sydney Basin Bioregion","Subtropical and Temperate Coastal Saltmarsh","Swamp Tea-tree (Melaleuca irbyana) Forest of South-east Queensland","Swamps of the Fleurieu Peninsula","Temperate Highland Peat Swamps on Sandstone","The community of native species dependent on natural discharge of groundwater from the Great Artesian Basin","Thrombolite (microbial) community of coastal freshwater lakes of the Swan Coastal Plain (Lake Richmond)","Thrombolite (microbialite) Community of a Coastal Brackish Lake (Lake Clifton)","Turpentine-Ironbark Forest in the Sydney Basin Bioregion","Upland Basalt Eucalypt Forests of the Sydney Basin Bioregion","Upland Wetlands of the New England Tablelands and the Monaro Plateau","Warkworth Sands Woodland of the Hunter Valley","Weeping Myall Woodlands","Western Sydney Dry Rainforest and Moist Woodland on Shale","White Box-Yellow Box-Blakely's Red Gum Grassy Woodland and Derived Native Grassland"];

            self.data.animalBreedingNos = ko.observable().extend({numericString:2});

            self.data.animalReleaseNumber = ko.observable().extend({numericString:2});

            self.data.conservationWorks = ko.observableArray([]);
            self.selectedconservationWorksRow = ko.observable();
        

            self.loadconservationWorks = function (data, append) {
                if (!append) {
                    self.data.conservationWorks([]);
                }
                if (data === undefined) {
                    self.addconservationWorksRow();
                } else {
                    $.each(data, function (i, obj) {
                        self.data.conservationWorks.push(new Output_ConservationWorksforThreatenedspecies_conservationWorksRow(obj));
                    });
                }
            };
            self.downloadconservationWorksTemplateWithData = function() {
                self.downloadDataTemplate('conservationWorks');
            }

            self.addconservationWorksRow = function () {
                var newRow = new Output_ConservationWorksforThreatenedspecies_conservationWorksRow();
                self.data.conservationWorks.push(newRow);
                
            };
            self.removeconservationWorksRow = function (row) {
                self.data.conservationWorks.remove(row);
                
            };
            self.conservationWorksrowCount = function () {
                return self.data.conservationWorks().length;
            };

            self.conservationWorksTableDataUploadVisible = ko.observable(false);
            self.showconservationWorksTableDataUpload = function() {
                self.conservationWorksTableDataUploadVisible(!self.conservationWorksTableDataUploadVisible());
            };

            self.templateDownloadUrl = function(type) {
                return '/proxy/excelOutputTemplate?listName=conservationWorks&type=';
            }

            self.conservationWorksTableDataUploadOptions = {
                    url:'/activity/ajaxUpload',
                    done:function(e, data) {
                        if (data.result.error) {
                            self.uploadFailed(data.result.error);
                        }
                        else {
                            self.loadconservationWorks(data.result.data, self.appendTableRows());
                        }
                    },
                    fail:function(e, data) {
                        var message = 'Please contact MERIT support and attach your spreadsheet to help us resolve the problem';
                        self.uploadFailed(data);

                    },
                    uploadTemplateId: "conservationWorkstemplate-upload",
                    downloadTemplateId: "conservationWorkstemplate-download",
                    formData:{type:'null', listName:'conservationWorks'}
            };
            self.appendTableRows = ko.observable(true);
            self.uploadFailed = function(message) {
                        var text = "<span class='label label-important'>Important</span><h4>There was an error uploading your data.</h4>";
                        text += "<p>"+message+"</p>";
                        bootbox.alert(text)
            };

            self.data.protectionMechanisms = ko.observableArray([]);
            self.selectedprotectionMechanismsRow = ko.observable();
        

            self.loadprotectionMechanisms = function (data, append) {
                if (!append) {
                    self.data.protectionMechanisms([]);
                }
                if (data === undefined) {
                    self.addprotectionMechanismsRow();
                } else {
                    $.each(data, function (i, obj) {
                        self.data.protectionMechanisms.push(new Output_ConservationWorksforThreatenedspecies_protectionMechanismsRow(obj));
                    });
                }
            };
            self.downloadprotectionMechanismsTemplateWithData = function() {
                self.downloadDataTemplate('protectionMechanisms');
            }

            self.addprotectionMechanismsRow = function () {
                var newRow = new Output_ConservationWorksforThreatenedspecies_protectionMechanismsRow();
                self.data.protectionMechanisms.push(newRow);
                
            };
            self.removeprotectionMechanismsRow = function (row) {
                self.data.protectionMechanisms.remove(row);
                
            };
            self.protectionMechanismsrowCount = function () {
                return self.data.protectionMechanisms().length;
            };

            self.protectionMechanismsTableDataUploadVisible = ko.observable(false);
            self.showprotectionMechanismsTableDataUpload = function() {
                self.protectionMechanismsTableDataUploadVisible(!self.protectionMechanismsTableDataUploadVisible());
            };

            self.templateDownloadUrl = function(type) {
                return '/proxy/excelOutputTemplate?listName=protectionMechanisms&type=';
            }

            self.protectionMechanismsTableDataUploadOptions = {
                    url:'/activity/ajaxUpload',
                    done:function(e, data) {
                        if (data.result.error) {
                            self.uploadFailed(data.result.error);
                        }
                        else {
                            self.loadprotectionMechanisms(data.result.data, self.appendTableRows());
                        }
                    },
                    fail:function(e, data) {
                        var message = 'Please contact MERIT support and attach your spreadsheet to help us resolve the problem';
                        self.uploadFailed(data);

                    },
                    uploadTemplateId: "protectionMechanismstemplate-upload",
                    downloadTemplateId: "protectionMechanismstemplate-download",
                    formData:{type:'null', listName:'protectionMechanisms'}
            };
            self.appendTableRows = ko.observable(true);
            self.uploadFailed = function(message) {
                        var text = "<span class='label label-important'>Important</span><h4>There was an error uploading your data.</h4>";
                        text += "<p>"+message+"</p>";
                        bootbox.alert(text)
            };

            self.data.notes = ko.observable();
            self.transients.site = site;

        // this will be called when generating a savable model to remove transient properties
        self.removeBeforeSave = function (jsData) {
            // add code to remove any transients added by the dynamic tags
                            delete jsData.selectedconservationWorksRow;
                delete jsData.conservationWorksTableDataUploadOptions
                delete jsData.conservationWorksTableDataUploadVisible
                delete jsData.selectedprotectionMechanismsRow;
                delete jsData.protectionMechanismsTableDataUploadOptions
                delete jsData.protectionMechanismsTableDataUploadVisible

            delete jsData.activityType;
            delete jsData.transients;
            return jsData;
        };

        // this returns a JS object ready for saving
        self.modelForSaving = function () {
            // get model as a plain javascript object
            var jsData = ko.mapping.toJS(self, {'ignore':['transients']});
            if (self.outputNotCompleted()) {
                jsData.data = {};
            }

            // get rid of any transient observables
            return self.removeBeforeSave(jsData);
        };

        // this is a version of toJSON that just returns the model as it will be saved
        // it is used for detecting when the model is modified (in a way that should invoke a save)
        // the ko.toJSON conversion is preserved so we can use it to view the active model for debugging
        self.modelAsJSON = function () {
            return JSON.stringify(self.modelForSaving());
        };

        self.loadData = function (data, documents) {
            // load dynamic data
                            self.data['targetSpecies'].loadData(data['targetSpecies']);
                self.data['targetTEC'](data['targetTEC']);
                self.data['animalBreedingNos'](orZero(data['animalBreedingNos']));
                self.data['animalReleaseNumber'](orZero(data['animalReleaseNumber']));
                self.loadconservationWorks(data.conservationWorks);
                self.loadprotectionMechanisms(data.protectionMechanisms);
                self.data['notes'](data['notes']);


            // if there is no data in tables then add an empty row for the user to add data
            if (typeof self.addRow === 'function' && self.rowCount() === 0) {
                self.addRow();
            }
            self.transients.dummy.notifySubscribers();
        };

        self.attachDocument = function(target) {
            var url = config.documentUpdateUrl || fcConfig.documentUpdateUrl;
            showDocumentAttachInModal(url, new DocumentViewModel({role:'information', stage:config.stage},{activityId:activityId, projectId:config.projectId}), '#attachDocument')
                    .done(function(result) {
                        target(new DocumentViewModel(result))
                    });
        };
        self.editDocumentMetadata = function(document) {
            var url = (config.documentUpdateUrl || fcConfig.documentUpdateUrl) + "/" + document.documentId;
            showDocumentAttachInModal(url, document, '#attachDocument');
        };
        self.deleteDocument = function(document) {
            document.status('deleted');
            var url = (config.documentDeleteUrl || fcConfig.documentDeleteUrl)+'/'+document.documentId;
            $.post(url, {}, function() {});

        };
    };
</script><script type="text/javascript">
        $(function(){

            var viewModelName = "Conservation_Works_DetailsViewModel",
                viewModelInstance = viewModelName + "Instance";

            // load dynamic models - usually objects in a list
                    var Output_ConservationWorksforThreatenedspecies_conservationWorksRow = function (data) {
            var self = this;
            if (!data) data = {};
            self.transients = {};
            this.conservationActionType = ko.observable(orBlank(data['conservationActionType']));
            self.transients.conservationActionTypeConstraints = ["Ecological thinning","Installation of nest boxes or other breeding/refuge structures","Restoring niche habitats","Seed bank establishment","Ex-situ breeding / propagation program","Other (specify in notes)"];
            this.areaImpactedByWorks = ko.observable(orZero(data['areaImpactedByWorks'])).extend({numericString:2});
        };
        var Output_ConservationWorksforThreatenedspecies_protectionMechanismsRow = function (data) {
            var self = this;
            if (!data) data = {};
            self.transients = {};
            this.protectionMechanism = ko.observable(orBlank(data['protectionMechanism']));
            self.transients.protectionMechanismConstraints = ["On title in perpetuity (eg Covenant Agreement)","Binding agreement not on title in perpetuity (eg Property Vegetation Plan)","Termed agreement not on title - binding (eg Land management agreement)","Not on title - non-binding (eg Wildlife Refuge)","No protection mechanism applicable","Other (specify in notes)"];
            this.numberOfProtectionMechanisms = ko.observable(orZero(data['numberOfProtectionMechanisms'])).extend({numericString:2});
            this.areaUnderAgreement = ko.observable(orZero(data['areaUnderAgreement'])).extend({numericString:2});
        };
        var speciesLists = [];
        var site = {};


            this[viewModelName] = function (output, config) {
                var self = this;
                self.name = "Conservation Works Details";
                self.outputId = orBlank(output.outputId);

                self.data = {};
                self.transients = {};
                var notCompleted = output.outputNotCompleted;

                if (notCompleted === undefined) {
                    notCompleted = config.collapsedByDefault;
                }
                self.transients.selectedSite = ko.observable(site);
                self.outputNotCompleted = ko.observable(notCompleted);
                self.transients.optional = config.optional || false;
                self.transients.questionText = config.optionalQuestionText || 'Not applicable';
                self.transients.dummy = ko.observable();

                // add declarations for dynamic data
                            self.data.targetSpecies = new SpeciesViewModel({}, speciesLists, {printable:''});

            self.data.targetTEC = ko.observable();
            self.transients.targetTECConstraints = ["Alpine Sphagnum Bogs and Associated Fens","Aquatic Root Mat Community 1 in Caves of the Leeuwin Naturaliste Ridge","Aquatic Root Mat Community 2 in Caves of the Leeuwin Naturaliste Ridge","Aquatic Root Mat Community 3 in Caves of the Leeuwin Naturaliste Ridge","Aquatic Root Mat Community 4 in Caves of the Leeuwin Naturaliste Ridge","Aquatic Root Mat Community in Caves of the Swan Coastal Plain","Arnhem Plateau Sandstone Shrubland Complex","Assemblages of plants and invertebrate animals of tumulus (organic mound) springs of the Swan Coastal Plain","Blue Gum High Forest of the Sydney Basin Bioregion","Brigalow (Acacia harpophylla dominant and co-dominant)","Broad leaf tea-tree (Melaleuca viridiflora) woodlands in high rainfall coastal north Queensland","Buloke Woodlands of the Riverina and Murray-Darling Depression Bioregions","Castlereagh Scribbly Gum and Agnes Banks Woodlands of the Sydney Basin Bioregion","Central Hunter Valley eucalypt forest and woodland","Claypans of the Swan Coastal Plain","Coastal Upland Swamps in the Sydney Basin Bioregion","Cooks River/Castlereagh Ironbark Forest of the Sydney Basin Bioregion","Coolibah - Black Box Woodlands of the Darling Riverine Plains and the Brigalow Belt South Bioregions","Corymbia calophylla - Kingia australis woodlands on heavy soils of the Swan Coastal Plain","Corymbia calophylla - Xanthorrhoea preissii woodlands and shrublands of the Swan Coastal Plain","Cumberland Plain Shale Woodlands and Shale-Gravel Transition Forest","Eastern Stirling Range Montane Heath and Thicket","Eastern Suburbs Banksia Scrub of the Sydney Region","Eucalypt Woodlands of the Western Australian Wheatbelt","Eucalyptus ovata - Callitris oblonga Forest","Eyre Peninsula Blue Gum (Eucalyptus petiolaris) Woodland","Giant Kelp Marine Forests of South East Australia","Gippsland Red Gum (Eucalyptus tereticornis subsp. mediana) Grassy Woodland and Associated Native Grassland","Grassy Eucalypt Woodland of the Victorian Volcanic Plain","Grey Box (Eucalyptus microcarpa) Grassy Woodlands and Derived Native Grasslands of South-eastern Australia","Hunter Valley Weeping Myall (Acacia pendula) Woodland","Iron-grass Natural Temperate Grassland of South Australia","Kangaroo Island Narrow-leaved Mallee (Eucalyptus cneorifolia) Woodland","Littoral Rainforest and Coastal Vine Thickets of Eastern Australia","Lowland Grassy Woodland in the South East Corner Bioregion","Lowland Native Grasslands of Tasmania","Lowland Rainforest of Subtropical Australia","Mabi Forest (Complex Notophyll Vine Forest 5b)","Monsoon vine thickets on the coastal sand dunes of Dampier Peninsula","Natural Damp Grassland of the Victorian Coastal Plains","Natural Grasslands of the Murray Valley Plains","Natural Grasslands of the Queensland Central Highlands and the northern Fitzroy Basin","Natural grasslands on basalt and fine-textured alluvial plains of northern New South Wales and southern Queensland","Natural Temperate Grassland of the South Eastern Highlands","Natural Temperate Grassland of the Victorian Volcanic Plain","New England Peppermint (Eucalyptus nova-anglica) Grassy Woodlands","Peppermint Box (Eucalyptus odorata) Grassy Woodland of South Australia","Perched Wetlands of the Wheatbelt region with extensive stands of living sheoak and paperbark across the lake floor (Toolibin Lake)","Posidonia australis seagrass meadows of the Manning-Hawkesbury ecoregion","Proteaceae Dominated Kwongkan Shrublands of the Southeast Coastal Floristic Province of Western Australia","Scott River Ironstone Association","Seasonal Herbaceous Wetlands (Freshwater) of the Temperate Lowland Plains","Sedgelands in Holocene dune swales of the southern Swan Coastal Plain","Semi-evergreen vine thickets of the Brigalow Belt (North and South) and Nandewar Bioregions","Shale Sandstone Transition Forest of the Sydney Basin Bioregion","Shrublands and Woodlands of the eastern Swan Coastal Plain","Shrublands and Woodlands on Muchea Limestone of the Swan Coastal Plain","Shrublands and Woodlands on Perth to Gingin ironstone (Perth to Gingin ironstone association) of the Swan Coastal Plain","Shrublands on southern Swan Coastal Plain ironstones","Silurian Limestone Pomaderris Shrubland of the South East Corner and Australian Alps Bioregions","Southern Highlands Shale Forest and Woodland in the Sydney Basin Bioregion","Subtropical and Temperate Coastal Saltmarsh","Swamp Tea-tree (Melaleuca irbyana) Forest of South-east Queensland","Swamps of the Fleurieu Peninsula","Temperate Highland Peat Swamps on Sandstone","The community of native species dependent on natural discharge of groundwater from the Great Artesian Basin","Thrombolite (microbial) community of coastal freshwater lakes of the Swan Coastal Plain (Lake Richmond)","Thrombolite (microbialite) Community of a Coastal Brackish Lake (Lake Clifton)","Turpentine-Ironbark Forest in the Sydney Basin Bioregion","Upland Basalt Eucalypt Forests of the Sydney Basin Bioregion","Upland Wetlands of the New England Tablelands and the Monaro Plateau","Warkworth Sands Woodland of the Hunter Valley","Weeping Myall Woodlands","Western Sydney Dry Rainforest and Moist Woodland on Shale","White Box-Yellow Box-Blakely's Red Gum Grassy Woodland and Derived Native Grassland"];

            self.data.animalBreedingNos = ko.observable().extend({numericString:2});

            self.data.animalReleaseNumber = ko.observable().extend({numericString:2});

            self.data.conservationWorks = ko.observableArray([]);
            self.selectedconservationWorksRow = ko.observable();
        

            self.loadconservationWorks = function (data, append) {
                if (!append) {
                    self.data.conservationWorks([]);
                }
                if (data === undefined) {
                    self.addconservationWorksRow();
                } else {
                    $.each(data, function (i, obj) {
                        self.data.conservationWorks.push(new Output_ConservationWorksforThreatenedspecies_conservationWorksRow(obj));
                    });
                }
            };
            self.downloadconservationWorksTemplateWithData = function() {
                self.downloadDataTemplate('conservationWorks');
            }

            self.addconservationWorksRow = function () {
                var newRow = new Output_ConservationWorksforThreatenedspecies_conservationWorksRow();
                self.data.conservationWorks.push(newRow);
                
            };
            self.removeconservationWorksRow = function (row) {
                self.data.conservationWorks.remove(row);
                
            };
            self.conservationWorksrowCount = function () {
                return self.data.conservationWorks().length;
            };

            self.conservationWorksTableDataUploadVisible = ko.observable(false);
            self.showconservationWorksTableDataUpload = function() {
                self.conservationWorksTableDataUploadVisible(!self.conservationWorksTableDataUploadVisible());
            };

            self.templateDownloadUrl = function(type) {
                return '/proxy/excelOutputTemplate?listName=conservationWorks&type=Conservation+Works+Details';
            }

            self.conservationWorksTableDataUploadOptions = {
                    url:'/activity/ajaxUpload',
                    done:function(e, data) {
                        if (data.result.error) {
                            self.uploadFailed(data.result.error);
                        }
                        else {
                            self.loadconservationWorks(data.result.data, self.appendTableRows());
                        }
                    },
                    fail:function(e, data) {
                        var message = 'Please contact MERIT support and attach your spreadsheet to help us resolve the problem';
                        self.uploadFailed(data);

                    },
                    uploadTemplateId: "conservationWorkstemplate-upload",
                    downloadTemplateId: "conservationWorkstemplate-download",
                    formData:{type:'Conservation Works Details', listName:'conservationWorks'}
            };
            self.appendTableRows = ko.observable(true);
            self.uploadFailed = function(message) {
                        var text = "<span class='label label-important'>Important</span><h4>There was an error uploading your data.</h4>";
                        text += "<p>"+message+"</p>";
                        bootbox.alert(text)
            };

            self.data.protectionMechanisms = ko.observableArray([]);
            self.selectedprotectionMechanismsRow = ko.observable();
        

            self.loadprotectionMechanisms = function (data, append) {
                if (!append) {
                    self.data.protectionMechanisms([]);
                }
                if (data === undefined) {
                    self.addprotectionMechanismsRow();
                } else {
                    $.each(data, function (i, obj) {
                        self.data.protectionMechanisms.push(new Output_ConservationWorksforThreatenedspecies_protectionMechanismsRow(obj));
                    });
                }
            };
            self.downloadprotectionMechanismsTemplateWithData = function() {
                self.downloadDataTemplate('protectionMechanisms');
            }

            self.addprotectionMechanismsRow = function () {
                var newRow = new Output_ConservationWorksforThreatenedspecies_protectionMechanismsRow();
                self.data.protectionMechanisms.push(newRow);
                
            };
            self.removeprotectionMechanismsRow = function (row) {
                self.data.protectionMechanisms.remove(row);
                
            };
            self.protectionMechanismsrowCount = function () {
                return self.data.protectionMechanisms().length;
            };

            self.protectionMechanismsTableDataUploadVisible = ko.observable(false);
            self.showprotectionMechanismsTableDataUpload = function() {
                self.protectionMechanismsTableDataUploadVisible(!self.protectionMechanismsTableDataUploadVisible());
            };

            self.templateDownloadUrl = function(type) {
                return '/proxy/excelOutputTemplate?listName=protectionMechanisms&type=Conservation+Works+Details';
            }

            self.protectionMechanismsTableDataUploadOptions = {
                    url:'/activity/ajaxUpload',
                    done:function(e, data) {
                        if (data.result.error) {
                            self.uploadFailed(data.result.error);
                        }
                        else {
                            self.loadprotectionMechanisms(data.result.data, self.appendTableRows());
                        }
                    },
                    fail:function(e, data) {
                        var message = 'Please contact MERIT support and attach your spreadsheet to help us resolve the problem';
                        self.uploadFailed(data);

                    },
                    uploadTemplateId: "protectionMechanismstemplate-upload",
                    downloadTemplateId: "protectionMechanismstemplate-download",
                    formData:{type:'Conservation Works Details', listName:'protectionMechanisms'}
            };
            self.appendTableRows = ko.observable(true);
            self.uploadFailed = function(message) {
                        var text = "<span class='label label-important'>Important</span><h4>There was an error uploading your data.</h4>";
                        text += "<p>"+message+"</p>";
                        bootbox.alert(text)
            };

            self.data.notes = ko.observable();
            self.transients.site = site;

                // this will be called when generating a savable model to remove transient properties
                self.removeBeforeSave = function (jsData) {
                    // add code to remove any transients added by the dynamic tags
                                    delete jsData.selectedconservationWorksRow;
                delete jsData.conservationWorksTableDataUploadOptions
                delete jsData.conservationWorksTableDataUploadVisible
                delete jsData.selectedprotectionMechanismsRow;
                delete jsData.protectionMechanismsTableDataUploadOptions
                delete jsData.protectionMechanismsTableDataUploadVisible

                    delete jsData.activityType;
                    delete jsData.transients;
                    return jsData;
                };

                // this returns a JS object ready for saving
                self.modelForSaving = function () {
                    // get model as a plain javascript object
                    var jsData = ko.mapping.toJS(self, {'ignore':['transients']});
                    if (self.outputNotCompleted()) {
                        jsData.data = {};
                    }
                    // get rid of any transient observables
                    return self.removeBeforeSave(jsData);
                };

                // this is a version of toJSON that just returns the model as it will be saved
                // it is used for detecting when the model is modified (in a way that should invoke a save)
                // the ko.toJSON conversion is preserved so we can use it to view the active model for debugging
                self.modelAsJSON = function () {
                    return JSON.stringify(self.modelForSaving());
                };

                self.loadData = function (data) {
                    // load dynamic data
                                    self.data['targetSpecies'].loadData(data['targetSpecies']);
                self.data['targetTEC'](data['targetTEC']);
                self.data['animalBreedingNos'](orZero(data['animalBreedingNos']));
                self.data['animalReleaseNumber'](orZero(data['animalReleaseNumber']));
                self.loadconservationWorks(data.conservationWorks);
                self.loadprotectionMechanisms(data.protectionMechanisms);
                self.data['notes'](data['notes']);


                    // if there is no data in tables then add an empty row for the user to add data
                    if (typeof self.addRow === 'function' && self.rowCount() === 0) {
                        self.addRow();
                    }
                    self.transients.dummy.notifySubscribers();
                };
            };


            var savedData = activity;
            if (!savedData.outputs) {
                savedData.outputs = [];
            }
            var savedOutput = {};
            if (savedData) {

                $.each(savedData.outputs, function(i, tmpOutput) {
                    if (tmpOutput.name === 'Conservation Works Details') {
                        savedOutput = tmpOutput;
                    }
                });
            }

            var config = JSON.parse('\u007b\u0022outputName\u0022:\u0022Conservation Works Details\u0022\u002c\u0022optional\u0022:false\u002c\u0022collapsedByDefault\u0022:false\u007d');
            window[viewModelInstance] = new this[viewModelName](savedOutput, config);
            var output = savedOutput.data ? savedOutput.data : {};

            window[viewModelInstance].loadData(output);
            window[viewModelInstance].dirtyFlag = ko.dirtyFlag(window[viewModelInstance], false);

            ko.applyBindings(window[viewModelInstance], document.getElementById("koConservation_Works_Details"));

            // this resets the baseline for detecting changes to the model
            // - shouldn't be required if everything behaves itself but acts as a backup for
            //   any binding side-effects
            // - note that it is not foolproof as applying the bindings happens asynchronously and there
            //   is no easy way to detect its completion
            window[viewModelInstance].dirtyFlag.reset();

            // register with the master controller so this model can participate in the save cycle
            master.register(window[viewModelInstance], window[viewModelInstance].modelForSaving,
            window[viewModelInstance].dirtyFlag.isDirty, window[viewModelInstance].dirtyFlag.reset);
        });

        </script><script type="text/javascript">
    
    // load dynamic models - usually objects in a list
            var speciesLists = [];
        var site = {};


    window["ViewModel"] = function (output, site, config) {
        var self = this;
        if (!output) {
            output = {};
        }
        var activityId = output.activityId || config.activityId || '';
        self.name = "";
        self.outputId = orBlank(output.outputId);

        self.data = {};
        self.transients = {};
        var notCompleted = output.outputNotCompleted;

        if (notCompleted === undefined) {
            notCompleted = config.collapsedByDefault;
        }

        self.transients.selectedSite = ko.observable(site);
        self.outputNotCompleted = ko.observable(notCompleted);
        self.transients.optional = config.optional || false;
        self.transients.questionText = config.optionalQuestionText || 'Not applicable';
        self.transients.dummy = ko.observable();

        self.downloadDataTemplate = function(listName) {
            var data = ko.mapping.toJS(self.data[listName](), {ignore:['transients']});
            var params = {
                listName:listName,
                type:self.name,
                data:JSON.stringify(data)
            };
            var url = '/activity/excelOutputTemplate';
            $.fileDownload(url, {
                httpMethod:'POST',
                data:params
            });

        };


        // add declarations for dynamic data
        
            self.data.totalParticipantsNotEmployed = ko.observable().extend({numericString:2});

            self.data.numberOfIndigenousParticipants = ko.observable().extend({numericString:2});

            self.data.numberOnCountryVisits = ko.observable().extend({numericString:2});

            self.data.totalParticipantsNew = ko.observable().extend({numericString:2});

            self.data.numberOfCommunityGroups = ko.observable().extend({numericString:2});

            self.data.numberOfFarmingEntitiesNew = ko.observable().extend({numericString:2});
            self.transients.site = site;

        // this will be called when generating a savable model to remove transient properties
        self.removeBeforeSave = function (jsData) {
            // add code to remove any transients added by the dynamic tags
            
            delete jsData.activityType;
            delete jsData.transients;
            return jsData;
        };

        // this returns a JS object ready for saving
        self.modelForSaving = function () {
            // get model as a plain javascript object
            var jsData = ko.mapping.toJS(self, {'ignore':['transients']});
            if (self.outputNotCompleted()) {
                jsData.data = {};
            }

            // get rid of any transient observables
            return self.removeBeforeSave(jsData);
        };

        // this is a version of toJSON that just returns the model as it will be saved
        // it is used for detecting when the model is modified (in a way that should invoke a save)
        // the ko.toJSON conversion is preserved so we can use it to view the active model for debugging
        self.modelAsJSON = function () {
            return JSON.stringify(self.modelForSaving());
        };

        self.loadData = function (data, documents) {
            // load dynamic data
                            self.data['totalParticipantsNotEmployed'](orZero(data['totalParticipantsNotEmployed']));
                self.data['numberOfIndigenousParticipants'](orZero(data['numberOfIndigenousParticipants']));
                self.data['numberOnCountryVisits'](orZero(data['numberOnCountryVisits']));
                self.data['totalParticipantsNew'](orZero(data['totalParticipantsNew']));
                self.data['numberOfCommunityGroups'](orZero(data['numberOfCommunityGroups']));
                self.data['numberOfFarmingEntitiesNew'](orZero(data['numberOfFarmingEntitiesNew']));


            // if there is no data in tables then add an empty row for the user to add data
            if (typeof self.addRow === 'function' && self.rowCount() === 0) {
                self.addRow();
            }
            self.transients.dummy.notifySubscribers();
        };

        self.attachDocument = function(target) {
            var url = config.documentUpdateUrl || fcConfig.documentUpdateUrl;
            showDocumentAttachInModal(url, new DocumentViewModel({role:'information', stage:config.stage},{activityId:activityId, projectId:config.projectId}), '#attachDocument')
                    .done(function(result) {
                        target(new DocumentViewModel(result))
                    });
        };
        self.editDocumentMetadata = function(document) {
            var url = (config.documentUpdateUrl || fcConfig.documentUpdateUrl) + "/" + document.documentId;
            showDocumentAttachInModal(url, document, '#attachDocument');
        };
        self.deleteDocument = function(document) {
            document.status('deleted');
            var url = (config.documentDeleteUrl || fcConfig.documentDeleteUrl)+'/'+document.documentId;
            $.post(url, {}, function() {});

        };
    };
</script><script type="text/javascript">
        $(function(){

            var viewModelName = "Participant_InformationViewModel",
                viewModelInstance = viewModelName + "Instance";

            // load dynamic models - usually objects in a list
                    var speciesLists = [];
        var site = {};


            this[viewModelName] = function (output, config) {
                var self = this;
                self.name = "Participant Information";
                self.outputId = orBlank(output.outputId);

                self.data = {};
                self.transients = {};
                var notCompleted = output.outputNotCompleted;

                if (notCompleted === undefined) {
                    notCompleted = config.collapsedByDefault;
                }
                self.transients.selectedSite = ko.observable(site);
                self.outputNotCompleted = ko.observable(notCompleted);
                self.transients.optional = config.optional || false;
                self.transients.questionText = config.optionalQuestionText || 'Not applicable';
                self.transients.dummy = ko.observable();

                // add declarations for dynamic data
                
            self.data.totalParticipantsNotEmployed = ko.observable().extend({numericString:2});

            self.data.numberOfIndigenousParticipants = ko.observable().extend({numericString:2});

            self.data.numberOnCountryVisits = ko.observable().extend({numericString:2});

            self.data.totalParticipantsNew = ko.observable().extend({numericString:2});

            self.data.numberOfCommunityGroups = ko.observable().extend({numericString:2});

            self.data.numberOfFarmingEntitiesNew = ko.observable().extend({numericString:2});
            self.transients.site = site;

                // this will be called when generating a savable model to remove transient properties
                self.removeBeforeSave = function (jsData) {
                    // add code to remove any transients added by the dynamic tags
                    
                    delete jsData.activityType;
                    delete jsData.transients;
                    return jsData;
                };

                // this returns a JS object ready for saving
                self.modelForSaving = function () {
                    // get model as a plain javascript object
                    var jsData = ko.mapping.toJS(self, {'ignore':['transients']});
                    if (self.outputNotCompleted()) {
                        jsData.data = {};
                    }
                    // get rid of any transient observables
                    return self.removeBeforeSave(jsData);
                };

                // this is a version of toJSON that just returns the model as it will be saved
                // it is used for detecting when the model is modified (in a way that should invoke a save)
                // the ko.toJSON conversion is preserved so we can use it to view the active model for debugging
                self.modelAsJSON = function () {
                    return JSON.stringify(self.modelForSaving());
                };

                self.loadData = function (data) {
                    // load dynamic data
                                    self.data['totalParticipantsNotEmployed'](orZero(data['totalParticipantsNotEmployed']));
                self.data['numberOfIndigenousParticipants'](orZero(data['numberOfIndigenousParticipants']));
                self.data['numberOnCountryVisits'](orZero(data['numberOnCountryVisits']));
                self.data['totalParticipantsNew'](orZero(data['totalParticipantsNew']));
                self.data['numberOfCommunityGroups'](orZero(data['numberOfCommunityGroups']));
                self.data['numberOfFarmingEntitiesNew'](orZero(data['numberOfFarmingEntitiesNew']));


                    // if there is no data in tables then add an empty row for the user to add data
                    if (typeof self.addRow === 'function' && self.rowCount() === 0) {
                        self.addRow();
                    }
                    self.transients.dummy.notifySubscribers();
                };
            };


            var savedData = activity;
            if (!savedData.outputs) {
                savedData.outputs = [];
            }
            var savedOutput = {};
            if (savedData) {

                $.each(savedData.outputs, function(i, tmpOutput) {
                    if (tmpOutput.name === 'Participant Information') {
                        savedOutput = tmpOutput;
                    }
                });
            }

            var config = JSON.parse('\u007b\u0022outputName\u0022:\u0022Participant Information\u0022\u002c\u0022optional\u0022:false\u002c\u0022collapsedByDefault\u0022:false\u007d');
            window[viewModelInstance] = new this[viewModelName](savedOutput, config);
            var output = savedOutput.data ? savedOutput.data : {};

            window[viewModelInstance].loadData(output);
            window[viewModelInstance].dirtyFlag = ko.dirtyFlag(window[viewModelInstance], false);

            ko.applyBindings(window[viewModelInstance], document.getElementById("koParticipant_Information"));

            // this resets the baseline for detecting changes to the model
            // - shouldn't be required if everything behaves itself but acts as a backup for
            //   any binding side-effects
            // - note that it is not foolproof as applying the bindings happens asynchronously and there
            //   is no easy way to detect its completion
            window[viewModelInstance].dirtyFlag.reset();

            // register with the master controller so this model can participate in the save cycle
            master.register(window[viewModelInstance], window[viewModelInstance].modelForSaving,
            window[viewModelInstance].dirtyFlag.isDirty, window[viewModelInstance].dirtyFlag.reset);
        });

        </script><script type="text/javascript">


    /* Master controller for page. This handles saving each model as required. */
    var Master = function () {
        var self = this;
        this.subscribers = [];
        // client models register their name and methods to participate in saving
        self.register = function (modelInstanceName, getMethod, isDirtyMethod, resetMethod) {
            this.subscribers.push({
                model: modelInstanceName,
                get: getMethod,
                isDirty: isDirtyMethod,
                reset: resetMethod
            });
        };
        // master isDirty flag for the whole page - can control button enabling
        this.isDirty  = function () {
            var dirty = false;
            $.each(this.subscribers, function(i, obj) {
                dirty = dirty || obj.isDirty();
            });
            return dirty;
        };

        this.validate = function() {
            var valid = $('#validation-container').validationEngine('validate');
            if (valid) {
                // Check that forms with multiple optional sections have at least one of those sections completed.
                var optionalCount = 0;
                var notCompletedCount = 0;
                $.each(self.subscribers, function(i, obj) {
                    if (obj.model !== 'activityModel' && obj.model !== 'photoPoints') {
                        if (obj.model.transients.optional) {
                            optionalCount++;
                            if (obj.model.outputNotCompleted()) {
                                notCompletedCount++;
                            }
                        }
                    }
                });
                if (optionalCount > 1 && notCompletedCount == optionalCount) {
                   valid = false;
                   bootbox.alert("<p>To 'Save changes', the mandatory fields of at least one section of this form must be completed.</p>"+
                        "<p>If all sections are 'Not applicable' please contact your grant manager to discuss alternate form options</p>");
                }
            }

            return valid;
        };
        /**
         * Makes an ajax call to save any sections that have been modified. This includes the activity
         * itself and each output.
         *
         * Modified outputs are injected as a list into the activity object. If there is nothing to save
         * in the activity itself, then the root is an object that is empty except for the outputs list.
         *
         * NOTE that the model for each section must register itself to be included in this save.
         *
         * Validates the entire page before saving.
         * @return -1 if the page was not modified, 0 if validation failed, 1 if validation succeeded (or was not requested).
         */
        this.save = function (validate) {
            // Ensure any active change is committed - the knockout binding typically fires on blur.
            $( document.activeElement ).blur();

            if (validate === undefined) {
                validate = true;
            }
            var activityData, outputs = [];

            var success = true;
            if (validate) {
                success = self.validate();
            }
            if (!self.isDirty()) {
                mobileBindings.onSaveActivity(-1, null);
                return -1;
            }
            if (success) {
                $.each(this.subscribers, function(i, obj) {
                    if (obj.model === 'activityModel') {
                        activityData = obj.get();
                    } else {
                        outputs.push(obj.get());
                    }
                });

                if (activityData === undefined) { activityData = {}}
                activityData.outputs = outputs;

                var toSave = JSON.stringify(activityData);
                mobileBindings.onSaveActivity(1, toSave);

            }
            else {
                mobileBindings.onSaveActivity(0, null);
            }
            return success?1:0;
        };

        this.reset = function () {
            $.each(this.subscribers, function(i, obj) {
                if (obj.isDirty()) {
                    obj.reset();
                }
            });
        };

        this.addSite = function(site) {
            var viewModel = ko.dataFor(document.getElementById('site'));
            viewModel.transients.sites.push(site);
            viewModel.siteId(site.siteId);
        }
    };

    if (mobileBindings == undefined) {
        var mobileBindings = {
        
            loadActivity:function(){return "{}"},
        
        
            loadSites:function(){return "[]"},
        
        
            loadThemes:function(){return "[]"},
        

        supportsNewSite:function() { return true; },
        onSaveActivity:function(){},
        createNewSite:function(){}
    };
}
var master = new Master();
var activity = JSON.parse(mobileBindings.loadActivity());
var sites = JSON.parse(mobileBindings.loadSites());
var themes = JSON.parse(mobileBindings.loadThemes());

$(function(){

var scroll = false;

    scroll = true;

$('#validation-container').validationEngine('attach', {scroll: scroll});

$('.helphover').popover({animation: true, trigger:'hover'});

$('#reset').click(function () {
master.reset();
});

function ViewModel (act, sites, themes) {
var self = this;
var today = new Date().toISOStringNoMillis();

self.activityId = act.activityId;
self.description = ko.observable(act.description);
self.notes = ko.observable(act.notes);
self.startDate = ko.observable(act.startDate || today).extend({simpleDate: false});
self.endDate = ko.observable(act.endDate).extend({simpleDate: false});
self.plannedStartDate = ko.observable(act.plannedStartDate).extend({simpleDate: false});
self.plannedEndDate = ko.observable(act.plannedEndDate).extend({simpleDate: false});
self.eventPurpose = ko.observable(act.eventPurpose);
self.fieldNotes = ko.observable(act.fieldNotes);
self.associatedProgram = ko.observable(act.associatedProgram);
self.associatedSubProgram = ko.observable(act.associatedSubProgram);
self.progress = ko.observable(act.progress);
self.mainTheme = ko.observable(act.mainTheme);
self.type = ko.observable(act.type);
self.siteId = ko.observable(act.siteId);
self.projectId = act.projectId;
self.transients = {};
self.transients.sites = ko.observableArray(sites);
self.transients.photoPoints = ko.computed(function() {
    var site = $.grep(self.transients.sites(), function(site, index) { return site.siteId == self.siteId(); })[0];
     if (site) {
         return site.photoPoints ? site.photoPoints : site.poi;
     }
     return [];
});
self.transients.activityProgressValues = ['planned','started','finished'];
self.transients.themes = themes?themes:[];
self.transients.markedAsFinished = ko.observable(act.progress === 'finished');
self.transients.markedAsFinished.subscribe(function (finished) {
    self.progress(finished ? 'finished' : 'started');
    if (finished || !self.endDate()) {
        self.endDate(today);
    }
});
self.transients.siteImgUrl = ko.computed(function() {
    if (self.siteId()) {
         var site = $.grep(self.transients.sites(), function(site, index) { return site.siteId == self.siteId(); })[0];
         if (site) {
            var lat,lon;
            if (site.centroidLat !== undefined && site.centroidLon !== undefined) {
                lat = site.centroidLat;
                lon = site.centroidLon;
            }
            else if (site.extent && site.extent.geometry && site.extent.geometry.centre) {
                lat = site.extent.geometry.centre[1];
                lon = site.extent.geometry.centre[0];
            }
            if (lat !== undefined && lon !== undefined) {
                $('#siteLocationImage').show();
                return fcConfig.googleStaticUrl+lat+","+lon;
            }
         }
    }
    return "";
});
self.siteLoadError = function(data, event) {
    $('#siteLocationImage').hide();
};

self.transients.newSiteSupported = ko.observable( mobileBindings.supportsNewSite());

self.modelForSaving = function () {
    // get model as a plain javascript object
    var jsData = ko.toJS(self);
    delete jsData.transients;
    return jsData;
};
self.modelAsJSON = function () {
    return JSON.stringify(self.modelForSaving());
};

self.save = function (callback, key) {
};

self.createNewSite = function() {
    mobileBindings.createNewSite();
}

self.notImplemented = function () {
    alert("Not implemented yet.")
};

self.attachPhotoPoint = function(e) {
    console.log(e);
};
self.dirtyFlag = ko.dirtyFlag(self, false);

// make sure progress moves to started if we save any data (unless already finished)
// (do this here so the model becomes dirty)
self.progress(self.transients.markedAsFinished() ? 'finished' : 'started');
}


var viewModel = new ViewModel(activity, sites, themes);

ko.applyBindings(viewModel);

master.register('activityModel', viewModel.modelForSaving, viewModel.dirtyFlag.isDirty, viewModel.dirtyFlag.reset);


// Workaround for Android bug 6721 - prevents components under the datepicker from receiving clicks on the datepicker.
var disabled = null;
$('[data-bind^=datepicker]').datepicker().on('show', function() {
    if (disabled == null) {
        disabled = $("input:enabled, select:enabled, button:enabled");
        disabled.prop('disabled', true);
    }
});
$('[data-bind^=datepicker]').datepicker().on('hide', function() {
    if (disabled !== null) {
        disabled.prop('disabled', false);
        disabled = null;
    }
});

});


</script>
</body>
</html>
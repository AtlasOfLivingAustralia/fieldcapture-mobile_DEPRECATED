

<!DOCTYPE html>
<head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <style type="text/css">
        input[type=checkbox] {
            -webkit-transform: scale(1.5); margin:50px;
        }
    </style>
    
    <script src="fieldcapture/static/UGoJGyG3j2UCffTg3vnOdi0FsnS2OvrmrsZD6WxaXGy.js" type="text/javascript" ></script>
<link href="fieldcapture/static/090onaZX1M508oSWqGmMeETZ9NkUA9p4CCTW3MUpRPc.css" type="text/css" rel="stylesheet" media="screen, projection" />

<link href="fieldcapture/static/CidRUyEAqkZsnDRPRiaGZBy7vd4DOlnRqweu4CsVcIG.css" type="text/css" rel="stylesheet" media="screen" />
<link href="fieldcapture/static/tDKPE9VWZfBnSnxBkPC52ml2dXticvlQDl9aR8VpM2o.css" type="text/css" rel="stylesheet" media="screen, projection" />
<!--[if lt IE 7]><link href="fieldcapture/static/v1vjA9BeNpSU8cuoTuVhTEUm6boSzwYQcgfPKKMkqgv.css" type="text/css" rel="stylesheet" media="screen, projection" /><![endif]-->

<link href="fieldcapture/static/Eu8FNKwJJQI8mVJO3VIshatRN1bunflYHvvdqk06tbf.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="http://www.ala.org.au/wp-content/themes/ala2011/images/favicon.ico" rel="shortcut icon" />
<!--[if lt IE 9]><script src="fieldcapture/static/Yh1Txee3hFzExJ4P1str7tGV24zQMEYtxqtlYJ5ukR0.js" type="text/javascript" ></script><![endif]-->
<link href="fieldcapture/static/6tuLClj7N5eYCZpx7vLn8juIbQUXBkCnWRUJFY7UDCz.css" type="text/css" rel="stylesheet" media="screen,print" />
<link href="/fieldcapture/static/7ARiB2rJgSkfi68hxnSlcG9Ot0gQ863DYxkCmSHQweE.png" rel="shortcut icon" />
<link href="/fieldcapture/static/14SWTr4VqVh6tnlUlgBtue6IJZ7gwE1y42RT7ya5GGW.png" rel="shortcut icon" />

<link href="fieldcapture/static/KYGDEVRRaKjNbTXJkHmicmzo9vFrnnzCnGLcxKjR04f.css" type="text/css" rel="stylesheet" media="screen,print" />

<link href="fieldcapture/static/uUQBvO5ITMKwLfoRb2u62GbHXEzxtsbrSWq8MBAOrbX.css" type="text/css" rel="stylesheet" media="screen,print" />
<link href="fieldcapture/static/2OXdKoom668LE7PLl0qjJCaLG7Pu7Jv869tAsS4e1oT.css" type="text/css" rel="stylesheet" media="screen, projection" />
<link href="fieldcapture/static/AcXIjLTuc87n8sfxBjJRQSoBIUwP9RnCyK8Sv82i7eV.css" type="text/css" rel="stylesheet" media="screen, projection" />
<script type="text/javascript">
    var fcConfig = {
        serverUrl: "http://devt.ala.org.au:8087/fieldcapture",
        activityUpdateUrl: "/fieldcapture/activity/ajaxUpdate",
        activityDeleteUrl: "/fieldcapture/activity/ajaxDelete",
        projectViewUrl: "/fieldcapture/project/index/",
        siteViewUrl: "/fieldcapture/site/index/",
        bieUrl: "http://bie.ala.org.au",
        speciesProfileUrl: "/fieldcapture/proxy/speciesProfile"
        },
        here = document.location.href;
    </script>
    

    <meta name="layout" content="mobile"/>

    <script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false&language=en"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jstimezonedetect/1.0.4/jstz.min.js"></script>
    
    

</head>

<body>

<div id="content" class="clearfix">
    
<div class="container-fluid validationEngineContainer" id="validation-container">
<div id="koActivityMainBlock">

    <div class="row-fluid">
        <div class="span9">
            <!-- Common activity fields -->

            <div class="row-fluid space-after">
                <div class="span6">
                    <label for="theme">Major theme</label>
                    <select id="theme" data-bind="value:mainTheme, options:transients.themes, optionsCaption:'Choose..'" class="input-xlarge">
                    </select>
                </div>
                <div class="span6">
                    <label class="for-readonly">Description</label>
                    <span class="readonly-text" data-bind="text:description"></span>
                </div>
            </div>

            <div class="row-fluid space-after">

                <div class="span6">
                    <label class="for-readonly inline">Activity progress</label>
                    <button type="button" class="btn btn-small"
                            data-bind="css: {'btn-warning':progress()=='planned','btn-success':progress()=='started','btn-info':progress()=='finished','btn-danger':progress()=='deferred','btn-inverse':progress()=='cancelled'}"
                            style="line-height:16px;cursor:default;color:white">
                        <span data-bind="text: progress"></span>
                    </button>
                </div>
            </div>

            <div class="row-fluid space-after">
                <div class="span6">
                    <label class="for-readonly inline">Planned start date</label>
                    <span class="readonly-text" data-bind="text:plannedStartDate.formattedDate"></span>
                </div>
                <div class="span6">
                    <label class="for-readonly inline">Planned end date</label>
                    <span class="readonly-text" data-bind="text:plannedEndDate.formattedDate"></span>
                </div>
            </div>

            <div class="row-fluid">
                <div class="span6 required">
                    <label for="startDate"><b>Actual start date</b>
                        <a href='#' class='helphover' data-original-title='Start date' data-placement='top' data-content='Date the activity was started.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a>
                    </label>


                    <div class="input-append">
                        <input data-bind='datepicker:startDate.date' name='startDate' id='startDate' type='text' size='16' class='input-xlarge' targetField='startDate.date' data-validation-engine='validate[required]' />
<span class='add-on open-datepicker'>
  <i class='icon-th'>&nbsp;</i>
</span>
                    </div>

                </div>
                <div class="span6 required">
                    <label for="endDate"><b>Actual end date</b>
                        <a href='#' class='helphover' data-original-title='End date' data-placement='top' data-content='Date the activity finished.'>
  <i class='icon-question-sign'>&nbsp;</i>
</a>
                    </label>

                    <div class="input-append">
                        <input data-bind='datepicker:endDate.date' name='endDate' id='endDate' type='text' size='16' class='input-xlarge' targetField='endDate.date' data-validation-engine='validate[future[startDate]]' />
<span class='add-on open-datepicker'>
  <i class='icon-th'>&nbsp;</i>
</span>
                    </div>

                </div>
            </div>


        </div>
        
            <div class="span3">
                <div id="smallMap" style="width:100%"></div>
            </div>
        
    </div>

</div>

<!-- ko stopBinding: true -->

    
    
    <style type="text/css">
        table.weedsTreated th {white-space:normal;}
        table.weedsTreated td:nth-child(1) {width:25%;}
        table.weedsTreated td:nth-child(1) select {width:100%;}
        table.weedsTreated td:nth-child(2) {width:15%;}
        table.weedsTreated td:nth-child(2) select {width:100%;}
        table.weedsTreated td:nth-child(3) {width:15%;}
        table.weedsTreated td:nth-child(3) select {width:100%;}
        table.weedsTreated td:nth-child(4) {width:15%;}
        table.weedsTreated td:nth-child(4) select {width:100%;}
        table.weedsTreated td:nth-child(5) {width:30%;}
        table.weedsTreated td:nth-child(5) select {width:100%;}
        table.weedsTreated td:last-child {width:4%;text-align:center;}
        table.weedsTreated textarea {width:98%;}
    </style>
    <div class="output-block" id="koWeed_Treatment_Details">
        <h3 data-bind="css:{modified:dirtyFlag.isDirty},attr:{title:'Has been modified'}">Weed Treatment Details<i class="icon-asterisk modified-icon" data-bind="visible:dirtyFlag.isDirty" title="Has been modified" style="display: none;"></i></h3>
        <!-- add the dynamic components -->
        <div class="row-fluid space-after output-section" >
<div class="span6">
<div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Type of treatment event:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The stage of treatment for the patch of weeds being treated'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><select class="span8" data-bind='value:data.treatmentEventType,options:transients.treatmentEventTypeConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Treatment area (Ha):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The area in hectares of the patch of the target species being treated'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.areaTreatedHa' data-validation-engine='validate[required,custom[number],min[0]]' type='number' class='input-mini'/></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel required"><label>Length of riparian or roadside area treated (Km):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The length in kilometres of the longest axis (eg. riparian, road, beach, etc.) of the treated area'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.linearAreaTreated' data-validation-engine='validate[required,custom[number],min[0]]' type='number' class='input-mini'/></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel"><label>Treatment cost ($/Ha):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The cost per hectare of the treatment'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.treatmentCostPerHa' data-validation-engine='validate[custom[number],min[0]]' type='number' class='input-mini'/></span></div></div><div class="span6">
<div class="row-fluid"><span class="span12">    <span  class="span4 preLabel"><label>Locality of the treatment area:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Brief description of the general locality in which the treatment works were undertaken'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><textarea  class="span8" data-bind='value:data.locality'></textarea></span></div><div class="row-fluid"><span class="span12">    <span  class="span4 preLabel"><label>If chemical treatment, please provide details (chemical & application rate):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='Details of chemical treatment including chemical agent and rate of application'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><textarea  class="span8" data-bind='value:data.chemicalDetails'></textarea></span></div></div></div>
<div class="row-fluid ">
            <table class="table table-bordered weedsTreated " >
                <thead><tr><th class="required">Target species:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The plant species being targeted for treatment (start typing a  scientific or common name for a species)'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th>Reproductive status at the time of treatment:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The reproductive status of the target species being treated'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th>Plant health at the time of treatment:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The general health of the patch of the target species being treated'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th class="required">Control status:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The control status of the patch of the target species being treated'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th class="required">Treatment method:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The method used to treat the patch of the target species'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></th><th></th>
                </tr></thead>
                <tbody data-bind="template:{name:'weedsTreatedviewTmpl', foreach: data.weedsTreated}"></tbody>
                <script id="weedsTreatedviewTmpl" type="text/html"><tr>
                    <td>
<span class="input-prepend input-append" data-bind="with:targetSpecies">
    <span class="add-on" data-bind="visible:!transients.editing(), css:{'btn-success':name()}"><i class="icon-white" data-bind="css:{'icon-ok':listId()!='unmatched' && name(), 'icon-question-sign':listId()=='unmatched'}"></i></span><span class="add-on" data-bind="visible:transients.editing()"><img src="/fieldcapture/static/Xo2jbaJ5EFqa59u9g4c4ybpCpw3wFWKhQdzZwNmmktO.gif" alt="saving icon" /></span><input type="text" data-bind="value:transients.textFieldValue,event:{focusout:focusLost},autocomplete:{url:'/fieldcapture/search/species', render: renderItem, listId: list, result:speciesSelected, valueChangeCallback:textFieldChanged}"  data-validation-engine='validate[required]'/>
    <span class="add-on" data-bind="visible: !transients.editing() && name()">
        <a href="#" data-bind="popover: {title: name, content: transients.speciesInformation}"><i class="icon-info-sign"></i></a>
    </span>
</span>
</td>
                    <td><select data-bind='value:reproductiveStatus,options:transients.reproductiveStatusConstraints,optionsCaption:"Please select"'></select></td>
                    <td><select data-bind='value:plantHealth,options:transients.plantHealthConstraints,optionsCaption:"Please select"'></select></td>
                    <td><select data-bind='value:controlStatus,options:transients.controlStatusConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></td>
                    <td><select data-bind='value:treatmentMethod,options:transients.treatmentMethodConstraints,optionsCaption:"Please select"' data-validation-engine='validate[required]'></select></td>
                    <td><i data-bind='click:$root.removeweedsTreatedRow' class='icon-remove'></i></td>
                </tr></script>
                <tfoot>
                <tr><td colspan="0" style="text-align:left;">
                        <button type="button" class="btn btn-small" data-bind="click:addweedsTreatedRow">
                        <i class="icon-plus"></i> Add a row</button>
                        <button type="button" class="btn btn-small" data-bind="click:showweedsTreatedTableDataUpload"><i class="icon-upload"></i> Upload data for this table</button>


                    </td></tr>
<tr data-bind="visible:weedsTreatedTableDataUploadVisible"><td colspan="0">
                <div class="text-error text-left">
                    Note: Only valid exact scientific names will be matched and populated from the database (indicated by a green tick). Unmatched species will load, but will be indicated by a green <b>?</b>. Please check your uploaded data and correct as required.
                </div>
                <div class="text-left" style="margin:5px">
                    <a href="/fieldcapture/proxy/excelOutputTemplate?type=Weed Treatment Details&listName=weedsTreated" target="weedsTreatedTemplateDownload" class="btn">Step 1 - Download template (.xlsx)</a>
                </div>
                <div class="text-left" style="margin:5px;">
                    <input type="checkbox" data-bind="checked:appendTableRows" style="margin-right:5px">Append uploaded data to table (unticking this checkbox will result in all table rows being replaced)
                </div>

                <div class="btn fileinput-button" style="margin-left:5px">
                        <input id="weedsTreatedTableDataUpload" type="file" name="data" data-bind="fileUploadNoImage:weedsTreatedTableDataUploadOptions">
                        Step 2 - Upload populated template
                </div>

                    </td></tr> <script id="weedsTreatedtemplate-upload" type="text/x-tmpl">{% %}</script>
                       <script id="weedsTreatedtemplate-download" type="text/x-tmpl">{% %}</script>                </tfoot>
            </table>
        </div>
<div class="row-fluid space-after output-section" >
<span class="span12">    <span  class="preLabel"><label>Comments / Notes</label></span><textarea  class="span12" data-bind='value:data.notes'></textarea></span></div>

        
    </div>

    
    
    
    <div class="output-block" id="koParticipant_Information">
        <h3 data-bind="css:{modified:dirtyFlag.isDirty},attr:{title:'Has been modified'}">Participant Information<i class="icon-asterisk modified-icon" data-bind="visible:dirtyFlag.isDirty" title="Has been modified" style="display: none;"></i></h3>
        <!-- add the dynamic components -->
        <div class="row-fluid space-after output-section">
<div class="row-fluid space-after " >
<span class="span2">    <span  class="preLabel required"><label>Total No. of Participants (not employed on project):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of participants involved in an activity who are not employed in the project'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.totalParticipantsNotEmployed' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span><span class="span2">    <span  class="preLabel required"><label>No of Indigenous Participants (not employed on project):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of indigenous people participating in an activity who are not employed in the project'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.numberOfIndigenousParticipants' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span><span class="span2">    <span  class="preLabel required"><label>Total No. of participants not previously attending events for this project (ie. new participants in the project):<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of participants involved in an activity who have not attended other activities associated with the project'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.totalParticipantsNew' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span><span class="span2">    <span  class="preLabel required"><label>Total No. of indigenous on-country visits:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of unique indigenous on-country visits undertaken as part of this activity'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.numberOnCountryVisits' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span><span class="span2">    <span  class="preLabel required"><label>No of community groups participating:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of different community groups participating in this activity'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.numberOfCommunityGroups' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span><span class="span2">    <span  class="preLabel required"><label>No of farming entities not previously attending events for this project:<a href='#' class='helphover' data-original-title='' data-placement='top' data-content='The number of farm entities represented by participants in an activity, which have not previously been represented at other project activities'>
  <i class='icon-question-sign'>&nbsp;</i>
</a></label></span><input class="input-small" style="text-align:center" data-bind='value:data.numberOfFarmingEntitiesNew' data-validation-engine='validate[required,min[0],custom[number]]' type='number' class='input-mini'/></span></div>
</div><div class="row-fluid space-after " >
<span class="span12">    </span></div>

        
    </div>

    
    
    <style type="text/css">
        table.photoPoints td:nth-child(1) {width:25%;}
        table.photoPoints td:nth-child(1) select {width:100%;}
        table.photoPoints td:nth-child(2) {width:40%;}
        table.photoPoints td:nth-child(2) select {width:100%;}
        table.photoPoints td:nth-child(3) {width:20%;}
        table.photoPoints td:nth-child(3) select {width:100%;}
        table.photoPoints td:last-child {width:5%;min-width:70px;text-align:center;}
        table.photoPoints textarea {width:98%;}
    </style>
    <div class="output-block" id="koPhoto_Points">
        <h3 data-bind="css:{modified:dirtyFlag.isDirty},attr:{title:'Has been modified'}">Photo Points<i class="icon-asterisk modified-icon" data-bind="visible:dirtyFlag.isDirty" title="Has been modified" style="display: none;"></i></h3>
        <!-- add the dynamic components -->
        <div class="row-fluid space-after " >
<span class="span12">    <span  class="span12"><strong>Note:</strong> Photo points are created and managed as a part of the site definition.  In order to record a photo point you first need to add a 'point of interest' to the site with a type of 'photo point'. When the site is selected for this activity, a row for each defined photo point will then appear in the table below, allowing you to upload your image taken at the time of the survey.</span></span></div>
<div class="row-fluid space-after " data-bind="visible:transients.site.siteId && !data.photoPoints().length">
<span class="span12">    <span  class="span12"><span><h4>Note: There are no photo points defined for this site.</h4></span></span></span></div>
<div class="row-fluid space-after " data-bind="visible:!transients.site.siteId">
<span class="span12">    <span  class="span12"><span><h4>Note: A site has not yet been selected for this activity. In order to upload a photo point image you must select the site at which this activity is being undertaken, and the site must have the photo point location recorded as a 'point of interest'.</h4></span></span></span></div>
<div class="row-fluid ">
            <table class="table table-bordered photoPoints " data-bind="independentlyValidated:data.photoPoints">
                <thead><tr><th>Photo point</th><th>Photo</th><th>Comment</th><th></th>
                </tr></thead>
                <tbody data-bind="template:{name:photoPointstemplateToUse, foreach: data.photoPoints}"></tbody>
                <script id="photoPointsviewTmpl" type="text/html"><tr>
                    <td>
        <div><b><span data-bind="text:name"/></b></div>
        <div>Lat:<span data-bind="text:lat"/></div>
        <div>Lon:<span data-bind="text:lon"/></div>
        <div>Bearing:<span data-bind="text:bearing"/></div>
        </td>
                    <td><ul class="imageList" data-bind="foreach: photo"><li><img data-bind="attr:{src: thumbnail_url}"></img></li></ul></td>
                    <td><span  data-bind='text:comment'></span></td>
                    <td>
                        <button class='btn btn-mini' data-bind='click:$root.editphotoPointsRow, enable:!$root.photoPointsEditing()' title='edit'><i class='icon-edit'></i> Edit</button>
                        <button class='btn btn-mini' data-bind='click:$root.removephotoPointsRow, enable:!$root.photoPointsEditing()' title='remove'><i class='icon-trash'></i> Remove</button>
                    </td>
                </tr></script>
                <script id="photoPointseditTmpl" type="text/html"><tr>
                    <td>
        <div><b><span data-bind="text:name"/></b></div>
        <div>Lat:<span data-bind="text:lat"/></div>
        <div>Lon:<span data-bind="text:lon"/></div>
        <div>Bearing:<span data-bind="text:bearing"/></div>
        </td>
                    <td><div id="fileupload" data-url="/fieldcapture/image/upload" data-bind="fileUpload:photo"
     class="fileupload-buttonbar">

    <table><tbody class="files"></tbody></table>
    <!-- The fileinput-button span is used to style the file input field as button -->
    <span class="btn fileinput-button">
        <i class="icon-plus"></i>
        <input type="file" name="files" multiple/>
        <span data-bind="visible:photo().length">Add more images</span>
        <span data-bind="visible:!photo().length">Add images</span>
    </span>

</div></td>
                    <td><input  class="input-small" data-bind='value:comment'  type='text' class='input-small'/></td>
                    <td>
                        <a class='btn btn-success btn-mini' data-bind='click:$root.acceptphotoPoints' href='#' title='save'>Update</a>
                        <a class='btn btn-mini' data-bind='click:$root.cancelphotoPoints' href='#' title='cancel'>Cancel</a>
                    </td>
                </tr></script>
                <tfoot>
                </tfoot>
            </table>
        </div>
<!-- The template to display files available for upload -->
<script id="template-upload" type="text/x-tmpl">
    {% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-upload fade">
        <td class="preview"><span class="fade"></span></td>
        <td class="name"><span>{%=file.name%}</span></td>
        <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
        {% if (file.error) { %}
        <td class="error" colspan="2"><span class="label label-important">{%=locale.fileupload.error%}</span> {%=locale.fileupload.errors[file.error] || file.error%}</td>
        {% } else if (o.files.valid && !i) { %}
        <td>
            <div class="progress progress-success progress-striped active"><div class="bar" style="width:0%;"></div></div>
        </td>
        <td class="start">{% if (!o.options.autoUpload) { %}
            <button class="btn btn-primary">
                <i class="icon-upload icon-white"></i>
                <span>{%=locale.fileupload.start%}</span>
            </button>
            {% } %}</td>
        {% } else { %}
        <td colspan="2"></td>
        {% } %}
        <td class="cancel">{% if (!i) { %}
            <button class="btn btn-warning">
                <i class="icon-ban-circle icon-white"></i>
                <span>{%=locale.fileupload.cancel%}</span>
            </button>
            {% } %}</td>
    </tr>
    {% } %}
</script>
<!-- The template to display files available for download -->
<script id="template-download" type="text/x-tmpl">
    {% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-download fade">
        {% if (file.error) { %}
        <td></td>
        <td><div class="name">{%=file.name%}</div><div class="size">{%=o.formatFileSize(file.size)%}</div></td>
        <td class="error" colspan="2"><span class="label label-important">{%=locale.fileupload.error%}</span> {%=locale.fileupload.errors[file.error] || file.error%}</td>
        {% } else { %}
        <td class="preview">{% if (file.thumbnail_url) { %}
            <a href="{%=file.url%}" title="{%=file.name%}" rel="gallery" download="{%=file.name%}"><img src="{%=file.thumbnail_url%}"></a>
            {% } %}</td>
        <td class="name" colspan="2">
            <a href="{%=file.url%}" title="{%=file.name%}" rel="{%=file.thumbnail_url&&'gallery'%}" download="{%=file.name%}">{%=file.name%}</a>
            <div class="size">{%=o.formatFileSize(file.size)%}</div>
        </td>

        {% } %}
        <td>
            <button class="delete-image delete btn btn-mini" data-type="DELETE" data-url="http://devt.ala.org.au:8087/fieldcapture/image/" data-filename="{%=file.name%}">
                <i class="icon-trash"></i>
                <span>{%=locale.fileupload.destroy%}</span>
            </button>
        </td>
    </tr>
    {% } %}
</script>
        
    </div>

<!-- /ko -->

</div>




</div>

<script src="fieldcapture/static/DzazZ2ePykd4QRUJlInoAO1LMvzeVxjM2JRcis2usBm.js" type="text/javascript" ></script>



<script src="fieldcapture/static/gfz9yoFSoT3bDIgFJCbjPP9WLeFgekRHSp7KxcpYrwj.js" type="text/javascript" ></script>
<script src="fieldcapture/static/HpQC03jqzgdovdmQNni1bswagCkkBPaWGDIzgICGcvq.js" type="text/javascript" ></script>









<!--[if gte IE 8]><script src="fieldcapture/static/knxjs4G9Cquc79O3iYW107XikPB1Z1ii8QWrtBpzlSP.js" type="text/javascript" ></script><![endif]-->
<script src="fieldcapture/static/kSJb30BxnBzyoP0WndxrtZbaNWzT8x6LP2Cp7xI9PH4.js" type="text/javascript" ></script>
<script src="fieldcapture/static/N1Pu1Yy1dAP26vjRfEw0sZtbZhL03ir303dL4C7EaVF.js" type="text/javascript" ></script>

<script src="fieldcapture/static/NbeGWZssK95I6Y1Oz4lzxzRtDzf9dyFLZiTstPEonQa.js" type="text/javascript" ></script>
<script src="fieldcapture/static/L85LaBY6yhQwMk24PuXWgqwvtkfvbmMZ3ExPR9xK96.js" type="text/javascript" ></script>
<script src="fieldcapture/static/MZjUSqmNLHqbPwhDcAMpejU18pr9ndMRCGKpPBHdSDL.js" type="text/javascript" ></script>
<script src="fieldcapture/static/1nCsTsYbdgqupwL47F4n7c98ss299Uck5fAVxaO9UuE.js" type="text/javascript" ></script>





<script src="fieldcapture/static/7l2mDQFFpMnG14cXQPTKd94AN71T8yUF6dHUA2LCJIo.js" type="text/javascript" ></script>
<script src="fieldcapture/static/ZbrF5cz3bJrkAqBXLrAlOmoaIYntVDIKpviQs5E8Rhy.js" type="text/javascript" ></script>
<script src="fieldcapture/static/yzVPTi9KJTOMgo1ytEFVw7JiBXXkkbj5dU3cYZoIuS.js" type="text/javascript" ></script>

<script src="fieldcapture/static/IZCc6ZgD3MepYbz4UqlDLzMDNNghSCivcfGebmF9V2d.js" type="text/javascript" ></script>
<script type="text/javascript">
        $(function(){

            var viewModelName = "Weed_Treatment_DetailsViewModel",
                viewModelInstance = viewModelName + "Instance";

            // load dynamic models - usually objects in a list
                    var WeedsTreatedRow = function (data) {
            var self = this;
            if (!data) data = {};
            self.transients = {};
            this.targetSpecies =  new SpeciesViewModel(data['targetSpecies'], speciesLists);
            this.reproductiveStatus = ko.observable(orBlank(data['reproductiveStatus']));
            self.transients.reproductiveStatusConstraints = ["Flowering (FLWG)","Seeding (SEDG)","Vegetative & Mature (VGTV)","Immature (IMTR)","Not recorded (NRRS)"];
            this.plantHealth = ko.observable(orBlank(data['plantHealth']));
            self.transients.plantHealthConstraints = ["Healthy","Stressed","Dead"];
            this.controlStatus = ko.observable(orBlank(data['controlStatus']));
            self.transients.controlStatusConstraints = ["New Infestation","Active Infestation","Under control","Under monitoring","Closed","Unknown"];
            this.treatmentMethod = ko.observable(orBlank(data['treatmentMethod']));
            self.transients.treatmentMethodConstraints = ["Environmental management - Fire","Environmental management - moisture & nutrient control","Environmental management - over-planting","Chemical control - Foliar spraying","Chemical control - Basal bark spraying","Chemical control - Stem injection","Chemical control - Cut stump","Chemical control - Cut and swab","Chemical control - Stem scraper","Chemical control - Wick applicators","Mechanical control - Slashing","Mechanical control - Mowing","Mechanical control - Dozing","Mechanical control - Pushing","Mechanical control - Felling","Manual control - Hand pulling","Manual control - Grubbing/chipping","Biological control - Biological agents (specify in notes)","Other (specify in notes)"];
        };
        var speciesLists = [];
        var site = {};


            this[viewModelName] = function (output) {
                var self = this;
                self.name = "Weed Treatment Details";
                self.outputId = "";
                self.data = {};
                self.transients = {};
                self.transients.dummy = ko.observable();

                // add declarations for dynamic data
            
            self.data.weedsTreated = ko.observableArray([]);
            self.selectedweedsTreatedRow = ko.observable();
        

            self.loadweedsTreated = function (data, append) {
                if (!append) {
                    self.data.weedsTreated([]);
                }
                if (data === undefined) {
                    self.addweedsTreatedRow();
                } else {
                    $.each(data, function (i, obj) {
                        self.data.weedsTreated.push(new WeedsTreatedRow(obj));
                    });
                }
            };

            self.addweedsTreatedRow = function () {
                var newRow = new WeedsTreatedRow();
                self.data.weedsTreated.push(newRow);
                
            };
            self.removeweedsTreatedRow = function (row) {
                self.data.weedsTreated.remove(row);
                
            };
            self.weedsTreatedrowCount = function () {
                return self.data.weedsTreated().length;
            };

            self.weedsTreatedTableDataUploadVisible = ko.observable(false);
            self.showweedsTreatedTableDataUpload = function() {
                self.weedsTreatedTableDataUploadVisible(!self.weedsTreatedTableDataUploadVisible());
            };

            self.weedsTreatedTableDataUploadOptions = {
                    url:'/fieldcapture/activity/ajaxUpload',
                    done:function(e, data) {
                        if (data.result.error) {
                            self.uploadFailed(data.result.error);
                        }
                        else {
                            self.loadweedsTreated(data.result.data, self.appendTableRows());
                        }
                    },
                    fail:function(e, data) {
                        var message = 'Please contact MERIT support and attach your spreadsheet to help us resolve the problem';
                        self.uploadFailed(data);

                    },
                    uploadTemplateId: "weedsTreatedtemplate-upload",
                    downloadTemplateId: "weedsTreatedtemplate-download",
                    formData:{type:'Weed Treatment Details', listName:'weedsTreated'}
            };
            self.appendTableRows = ko.observable(true);
            self.uploadFailed = function(message) {
                        var text = "<span class='label label-important'>Important</span><h4>There was an error uploading your data.</h4>";
                        text += "<p>"+message+"</p>";
                        bootbox.alert(text)
            };

            self.data.treatmentEventType = ko.observable();
            self.transients.treatmentEventTypeConstraints = ["Initial treatment","Follow-up treatment"];

            self.data.locality = ko.observable();

            self.data.areaTreatedHa = ko.observable();

            self.data.linearAreaTreated = ko.observable();

            self.data.chemicalDetails = ko.observable();

            self.data.treatmentCostPerHa = ko.observable();

            self.data.notes = ko.observable();
            self.transients.site = site;

            // this will be called when generating a savable model to remove transient properties
            self.removeBeforeSave = function (jsData) {
                // add code to remove any transients added by the dynamic tags
                            delete jsData.selectedweedsTreatedRow;
                delete jsData.weedsTreatedTableDataUploadOptions
                delete jsData.weedsTreatedTableDataUploadVisible

            delete jsData.activityType;
            delete jsData.transients;
            return jsData;
        };

        // this returns a JS object ready for saving
        self.modelForSaving = function () {
            // get model as a plain javascript object
            var jsData = ko.mapping.toJS(self, {'ignore':['transients']});
            // get rid of any transient observables
            return self.removeBeforeSave(jsData);
        };

        // this is a version of toJSON that just returns the model as it will be saved
        // it is used for detecting when the model is modified (in a way that should invoke a save)
        // the ko.toJSON conversion is preserved so we can use it to view the active model for debugging
        self.modelAsJSON = function () {
            return JSON.stringify(self.modelForSaving());
        };

        self.loadData = function (outputId, data) {
            self.outputId = outputId;
            // load dynamic data
                            self.loadweedsTreated(data.weedsTreated);
                self.data['treatmentEventType'](data['treatmentEventType']);
                self.data['locality'](data['locality']);
                self.data['areaTreatedHa'](orZero(data['areaTreatedHa']));
                self.data['linearAreaTreated'](orZero(data['linearAreaTreated']));
                self.data['chemicalDetails'](data['chemicalDetails']);
                self.data['treatmentCostPerHa'](orZero(data['treatmentCostPerHa']));
                self.data['notes'](data['notes']);


            // if there is no data in tables then add an empty row for the user to add data
            if (typeof self.addRow === 'function' && self.rowCount() === 0) {
                self.addRow();
            }
            self.transients.dummy.notifySubscribers();
        };
    };

    window[viewModelInstance] = new this[viewModelName]();
            window[viewModelInstance].dirtyFlag = ko.dirtyFlag(window[viewModelInstance], false);

            ko.applyBindings(window[viewModelInstance], document.getElementById("koWeed_Treatment_Details"));

            // this resets the baseline for detecting changes to the model
            // - shouldn't be required if everything behaves itself but acts as a backup for
            //   any binding side-effects
            // - note that it is not foolproof as applying the bindings happens asynchronously and there
            //   is no easy way to detect its completion
            window[viewModelInstance].dirtyFlag.reset();

            // register with the master controller so this model can participate in the save cycle
            master.register(viewModelInstance, window[viewModelInstance].modelForSaving,
             window[viewModelInstance].dirtyFlag.isDirty, window[viewModelInstance].dirtyFlag.reset);

            // Check for locally saved data for this output - this will happen in the event of a session timeout
            // for example.
            var savedData = activity;
            if (!savedData.outputs) {
                savedData.outputs = [];
            }
            console.log(savedData);
            var savedOutput = null;
            var savedOutputId = null;
            if (savedData) {

                $.each(savedData.outputs, function(i, tmpOutput) {
                    if (tmpOutput.name === 'Weed Treatment Details') {
                        if (tmpOutput.data) {
                            savedOutput = tmpOutput.data;

                        }
                    }
                });
            }
            if (savedOutput) {
                window[viewModelInstance].loadData(savedOutputId, savedOutput);
            }
        });

        
        $(function(){

            var viewModelName = "Participant_InformationViewModel",
                viewModelInstance = viewModelName + "Instance";

            // load dynamic models - usually objects in a list
                    var speciesLists = [];
        var site = {};


            this[viewModelName] = function (output) {
                var self = this;
                self.name = "Participant Information";
                self.outputId = "";
                self.data = {};
                self.transients = {};
                self.transients.dummy = ko.observable();

                // add declarations for dynamic data
            
            self.data.totalParticipantsNotEmployed = ko.observable();

            self.data.numberOfIndigenousParticipants = ko.observable();

            self.data.numberOnCountryVisits = ko.observable();

            self.data.totalParticipantsNew = ko.observable();

            self.data.numberOfCommunityGroups = ko.observable();

            self.data.numberOfFarmingEntitiesNew = ko.observable();
            self.transients.site = site;

            // this will be called when generating a savable model to remove transient properties
            self.removeBeforeSave = function (jsData) {
                // add code to remove any transients added by the dynamic tags
            
            delete jsData.activityType;
            delete jsData.transients;
            return jsData;
        };

        // this returns a JS object ready for saving
        self.modelForSaving = function () {
            // get model as a plain javascript object
            var jsData = ko.mapping.toJS(self, {'ignore':['transients']});
            // get rid of any transient observables
            return self.removeBeforeSave(jsData);
        };

        // this is a version of toJSON that just returns the model as it will be saved
        // it is used for detecting when the model is modified (in a way that should invoke a save)
        // the ko.toJSON conversion is preserved so we can use it to view the active model for debugging
        self.modelAsJSON = function () {
            return JSON.stringify(self.modelForSaving());
        };

        self.loadData = function (outputId, data) {
            self.outputId = outputId;
            // load dynamic data
                            self.data['totalParticipantsNotEmployed'](orZero(data['totalParticipantsNotEmployed']));
                self.data['numberOfIndigenousParticipants'](orZero(data['numberOfIndigenousParticipants']));
                self.data['numberOnCountryVisits'](orZero(data['numberOnCountryVisits']));
                self.data['totalParticipantsNew'](orZero(data['totalParticipantsNew']));
                self.data['numberOfCommunityGroups'](orZero(data['numberOfCommunityGroups']));
                self.data['numberOfFarmingEntitiesNew'](orZero(data['numberOfFarmingEntitiesNew']));


            // if there is no data in tables then add an empty row for the user to add data
            if (typeof self.addRow === 'function' && self.rowCount() === 0) {
                self.addRow();
            }
            self.transients.dummy.notifySubscribers();
        };
    };

    window[viewModelInstance] = new this[viewModelName]();
            window[viewModelInstance].dirtyFlag = ko.dirtyFlag(window[viewModelInstance], false);

            ko.applyBindings(window[viewModelInstance], document.getElementById("koParticipant_Information"));

            // this resets the baseline for detecting changes to the model
            // - shouldn't be required if everything behaves itself but acts as a backup for
            //   any binding side-effects
            // - note that it is not foolproof as applying the bindings happens asynchronously and there
            //   is no easy way to detect its completion
            window[viewModelInstance].dirtyFlag.reset();

            // register with the master controller so this model can participate in the save cycle
            master.register(viewModelInstance, window[viewModelInstance].modelForSaving,
             window[viewModelInstance].dirtyFlag.isDirty, window[viewModelInstance].dirtyFlag.reset);

            // Check for locally saved data for this output - this will happen in the event of a session timeout
            // for example.
            var savedData = activity;
            if (!savedData.outputs) {
                savedData.outputs = [];
            }
            console.log(savedData);
            var savedOutput = null;
            var savedOutputId = null;
            if (savedData) {

                $.each(savedData.outputs, function(i, tmpOutput) {
                    if (tmpOutput.name === 'Participant Information') {
                        if (tmpOutput.data) {
                            savedOutput = tmpOutput.data;

                        }
                    }
                });
            }
            if (savedOutput) {
                window[viewModelInstance].loadData(savedOutputId, savedOutput);
            }
        });

        
        $(function(){

            var viewModelName = "Photo_PointsViewModel",
                viewModelInstance = viewModelName + "Instance";

            // load dynamic models - usually objects in a list
                    var PhotoPointsRow = function (data) {
            var self = this;
            if (!data) data = {};
            self.transients = {};
            this.isSelected = ko.observable(false);

            this.commit = function () {
                self.doAction('commit');
            };
            this.reset = function () {
                self.doAction('reset');
            };
            this.doAction = function (action) {
                var prop, item;
                for (prop in self) {
                    if (self.hasOwnProperty(prop)) {
                        item = self[prop];
                        if (ko.isObservable(item) && item[action]) {
                           item[action]();
                        }
                    }
                }
            };
            this.isNew = false;
            this.toJSON = function () {
                return ko.mapping.toJS(this, {'ignore':['transients', 'isNew', 'isSelected']});
            };
            this.name = ko.protectedObservable(orBlank(data['name']));
            this.photo = ko.observableArray();
            if (data['photo'] instanceof Array) {
                this.photo(data['photo']);
            } else if (data['photo']) {
                this.photo.push(data['photo']);
            }
            this.comment = ko.protectedObservable(orBlank(data['comment']));
        };
        var speciesLists = [];
        var site = {};


            this[viewModelName] = function (output) {
                var self = this;
                self.name = "Photo Points";
                self.outputId = "";
                self.data = {};
                self.transients = {};
                self.transients.dummy = ko.observable();

                // add declarations for dynamic data
            
            self.data.photoPoints = ko.observableArray([]);
            self.selectedphotoPointsRow = ko.observable();
        
            self.addphotoPointsRow = function () {
                var newRow = new PhotoPointsRow();
                self.data.photoPoints.push(newRow);
                newRow.isNew = true; self.editphotoPointsRow(newRow);
            };
            self.removephotoPointsRow = function (row) {
                self.data.photoPoints.remove(row);
                self.selectedphotoPointsRow(null);
            };
            self.photoPointsrowCount = function () {
                return self.data.photoPoints().length;
            };

            self.photoPointsTableDataUploadVisible = ko.observable(false);
            self.showphotoPointsTableDataUpload = function() {
                self.photoPointsTableDataUploadVisible(!self.photoPointsTableDataUploadVisible());
            };

            self.photoPointsTableDataUploadOptions = {
                    url:'/fieldcapture/activity/ajaxUpload',
                    done:function(e, data) {
                        if (data.result.error) {
                            self.uploadFailed(data.result.error);
                        }
                        else {
                            self.loadphotoPoints(data.result.data, self.appendTableRows());
                        }
                    },
                    fail:function(e, data) {
                        var message = 'Please contact MERIT support and attach your spreadsheet to help us resolve the problem';
                        self.uploadFailed(data);

                    },
                    uploadTemplateId: "photoPointstemplate-upload",
                    downloadTemplateId: "photoPointstemplate-download",
                    formData:{type:'Photo Points', listName:'photoPoints'}
            };
            self.appendTableRows = ko.observable(true);
            self.uploadFailed = function(message) {
                        var text = "<span class='label label-important'>Important</span><h4>There was an error uploading your data.</h4>";
                        text += "<p>"+message+"</p>";
                        bootbox.alert(text)
            };

            self.photoPointstemplateToUse = function (row) {
                return self.selectedphotoPointsRow() === row ? 'photoPointseditTmpl' : 'photoPointsviewTmpl';
            };
            self.editphotoPointsRow = function (row) {
                self.selectedphotoPointsRow(row);
                row.isSelected(true);
            };
            self.acceptphotoPoints = function (row, event) {
            if($(event.currentTarget).closest('.validationEngineContainer').validationEngine('validate')) {
                // todo: validation
                row.commit();
                self.selectedphotoPointsRow(null);
                row.isSelected(false);
                row.isNew = false;
                };
            };
            self.cancelphotoPoints = function (row) {
                if (row.isNew) {
                    self.removephotoPointsRow(row);
                } else {
                    row.reset();
                    self.selectedphotoPointsRow(null);
                    row.isSelected(false);
                }
            };
            self.photoPointsEditing = function() {
                return self.selectedphotoPointsRow() != null;
            };
var PhotoPoint = function(data) {
    this.name = data.name;
    this.lat = data.geometry.decimalLatitude;
    this.lon = data.geometry.decimalLongitude;
    this.bearing = data.geometry.bearing;
    this.description = data.description;
};

self.loadphotoPoints = function(data) {
    var photoPointByName = function(name, data) {
        var photoPoint;
        if (data !== undefined) {
            $.each(data, function(index, obj) {
                if (obj.name === name) {
                    photoPoint = obj;
                    return false;
                }
            });
        }
        return photoPoint;
    };
    if (site !== undefined && site.poi !== undefined) {
        $.each(site.poi, function(index, obj) {
            var photoPoint = new PhotoPoint(obj);
            var photoPointData = photoPointByName(obj.name, data);
            if (photoPointData === undefined) {
                photoPointData = {comment:"", photo:[]};
            }
            var row = new PhotoPointsRow(photoPointData);
            $.extend(row, photoPoint);

            self.data.photoPoints.push(row);
        });
    }
};

self.removePhotoPoint = function(photoPoint) {
   self.data.photoPoints.remove(photoPoint);
};            self.transients.site = site;

            // this will be called when generating a savable model to remove transient properties
            self.removeBeforeSave = function (jsData) {
                // add code to remove any transients added by the dynamic tags
                            delete jsData.selectedphotoPointsRow;
                delete jsData.photoPointsTableDataUploadOptions
                delete jsData.photoPointsTableDataUploadVisible

            delete jsData.activityType;
            delete jsData.transients;
            return jsData;
        };

        // this returns a JS object ready for saving
        self.modelForSaving = function () {
            // get model as a plain javascript object
            var jsData = ko.mapping.toJS(self, {'ignore':['transients']});
            // get rid of any transient observables
            return self.removeBeforeSave(jsData);
        };

        // this is a version of toJSON that just returns the model as it will be saved
        // it is used for detecting when the model is modified (in a way that should invoke a save)
        // the ko.toJSON conversion is preserved so we can use it to view the active model for debugging
        self.modelAsJSON = function () {
            return JSON.stringify(self.modelForSaving());
        };

        self.loadData = function (outputId, data) {
            self.outputId = outputId;
            // load dynamic data
                            self.loadphotoPoints(data['photoPoints']);


            // if there is no data in tables then add an empty row for the user to add data
            if (typeof self.addRow === 'function' && self.rowCount() === 0) {
                self.addRow();
            }
            self.transients.dummy.notifySubscribers();
        };
    };

    window[viewModelInstance] = new this[viewModelName]();
            window[viewModelInstance].dirtyFlag = ko.dirtyFlag(window[viewModelInstance], false);

            ko.applyBindings(window[viewModelInstance], document.getElementById("koPhoto_Points"));

            // this resets the baseline for detecting changes to the model
            // - shouldn't be required if everything behaves itself but acts as a backup for
            //   any binding side-effects
            // - note that it is not foolproof as applying the bindings happens asynchronously and there
            //   is no easy way to detect its completion
            window[viewModelInstance].dirtyFlag.reset();

            // register with the master controller so this model can participate in the save cycle
            master.register(viewModelInstance, window[viewModelInstance].modelForSaving,
             window[viewModelInstance].dirtyFlag.isDirty, window[viewModelInstance].dirtyFlag.reset);

            // Check for locally saved data for this output - this will happen in the event of a session timeout
            // for example.
            var savedData = activity;
            if (!savedData.outputs) {
                savedData.outputs = [];
            }
            console.log(savedData);
            var savedOutput = null;
            var savedOutputId = null;
            if (savedData) {

                $.each(savedData.outputs, function(i, tmpOutput) {
                    if (tmpOutput.name === 'Photo Points') {
                        if (tmpOutput.data) {
                            savedOutput = tmpOutput.data;

                        }
                    }
                });
            }
            if (savedOutput) {
                window[viewModelInstance].loadData(savedOutputId, savedOutput);
            }
        });

        


    /* Master controller for page. This handles saving each model as required. */
    var Master = function () {
        var self = this;
        this.subscribers = [];
        // client models register their name and methods to participate in saving
        self.register = function (modelInstanceName, getMethod, isDirtyMethod, resetMethod) {
            this.subscribers.push({
                model: modelInstanceName,
                get: getMethod,
                isDirty: isDirtyMethod,
                reset: resetMethod
            });
        };
        // master isDirty flag for the whole page - can control button enabling
        this.isDirty  = function () {
            var dirty = false;
            $.each(this.subscribers, function(i, obj) {
                dirty = dirty || obj.isDirty();
            });
            return dirty;
        };
        /**
         * Makes an ajax call to save any sections that have been modified. This includes the activity
         * itself and each output.
         *
         * Modified outputs are injected as a list into the activity object. If there is nothing to save
         * in the activity itself, then the root is an object that is empty except for the outputs list.
         *
         * NOTE that the model for each section must register itself to be included in this save.
         *
         * Validates the entire page before saving.
         */
        this.save = function () {

            var activityData, outputs = [];
            if ($('#validation-container').validationEngine('validate')) {
                $.each(this.subscribers, function(i, obj) {
                   // if (obj.isDirty()) {
                        if (obj.model === 'activityModel') {
                            activityData = obj.get();
                        } else {
                            outputs.push(obj.get());
                        }
                    //}
                });
                if (outputs.length === 0 && activityData === undefined) {
                    alert("Nothing to save.");
                    return;
                }
                if (activityData === undefined) { activityData = {}}
                activityData.outputs = outputs;

                var toSave = JSON.stringify(activityData);
                console.log("saving"+toSave);
                mobileBindings.saveActivity(toSave);

            }

        };

        this.reset = function () {
            $.each(this.subscribers, function(i, obj) {
                if (obj.isDirty()) {
                    obj.reset();
                }
            });
        };
    };

    if (mobileBindings == undefined) {
        var mobileBindings = {
        loadActivity:function(){return "{}"},
        saveActivity:function(){}
        };
    }
    var master = new Master();
    var activity = JSON.parse(mobileBindings.loadActivity());
    var themes = ['theme1', 'theme2'];

    var site = {};


    $(function(){

        console.log("Blah!");

        $('#validation-container').validationEngine('attach', {scroll: false});

        $('.helphover').popover({animation: true, trigger:'hover'});

        $('#reset').click(function () {
            master.reset();
        });


        ko.bindingHandlers.editOutput = {
            init: function(element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
                var outputName = ko.utils.unwrapObservable(valueAccessor()),
                    activity = bindingContext.$root,
                    outputId;

                // search for corresponding outputs in the activity data
                $.each(activity.outputs, function (i,output) { // iterate output data in the activity to
                                                                  // find any matching the meta-model name
                    if (output.name === outputName) {
                        outputId = output.outputId;
                    }
                });
                if (outputId) {
                    // build edit link
                    $(element).html('Edit data');
                    $(element).attr('href', fcConfig.serverUrl + "/output/edit/" + outputId +
                        "?returnTo=" + here);
                } else {
                    // build create link
                    $(element).attr('href', fcConfig.serverUrl + '/output/create?activityId=' + activity.activityId +
                        '&outputName=' + encodeURIComponent(outputName) +
                        "&returnTo=" + here);
                }
            }
        };

        function ViewModel (act, site) {
            var self = this;
            self.activityId = act.activityId;
            self.description = ko.observable(act.description);
            self.notes = ko.observable(act.notes);
            self.startDate = ko.observable(act.startDate).extend({simpleDate: false});
            self.endDate = ko.observable(act.endDate || act.plannedEndDate).extend({simpleDate: false});
            self.plannedStartDate = ko.observable(act.plannedStartDate).extend({simpleDate: false});
            self.plannedEndDate = ko.observable(act.plannedEndDate).extend({simpleDate: false});
            self.eventPurpose = ko.observable(act.eventPurpose);
            self.fieldNotes = ko.observable(act.fieldNotes);
            self.associatedProgram = ko.observable(act.associatedProgram);
            self.associatedSubProgram = ko.observable(act.associatedSubProgram);
            self.progress = ko.observable(act.progress);
            self.mainTheme = ko.observable(act.mainTheme);
            self.type = ko.observable(act.type);
            self.siteId = ko.observable(act.siteId);
            self.projectId = act.projectId;
            self.transients = {};
            self.transients.site = site;
            self.transients.activityProgressValues = ['planned','started','finished'];
            self.transients.themes = themes;
            self.transients.markedAsFinished = ko.observable(act.progress === 'finished');
            self.transients.markedAsFinished.subscribe(function (finished) {
                self.progress(finished ? 'finished' : 'started');
            });

            self.modelForSaving = function () {
                // get model as a plain javascript object
                var jsData = ko.toJS(self);
                delete jsData.transients;
                return jsData;
            };
            self.modelAsJSON = function () {
                return JSON.stringify(self.modelForSaving());
            };

            self.save = function (callback, key) {
            };

            self.notImplemented = function () {
                alert("Not implemented yet.")
            };
            self.dirtyFlag = ko.dirtyFlag(self, false);

            // make sure progress moves to started if we save any data (unless already finished)
            // (do this here so the model becomes dirty)
            self.progress(self.transients.markedAsFinished() ? 'finished' : 'started');
        }


        var viewModel = new ViewModel(activity, site);

        ko.applyBindings(viewModel);

        master.register('activityModel', viewModel.modelForSaving, viewModel.dirtyFlag.isDirty, viewModel.dirtyFlag.reset);

        var mapFeatures = $.parseJSON('');
        if(mapFeatures !=null && mapFeatures.features !== undefined && mapFeatures.features.length >0){
            init_map_with_features({
                    mapContainer: "smallMap",
                    zoomToBounds:true,
                    zoomLimit:16,
                    featureService: "/fieldcapture/proxy/feature",
                    wmsServer: "http://spatial-dev.ala.org.au/geoserver"
                },
                mapFeatures
            );
        }
    });
</script>
</body>
</html>